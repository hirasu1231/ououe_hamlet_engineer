(window.webpackJsonp=window.webpackJsonp||[]).push([[137],{498:function(e,r,t){"use strict";t.r(r);var a=t(2),i=Object(a.a)({},(function(){var e=this,r=e.$createElement,t=e._self._c||r;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("p",[e._v("'「ゼロからのOS自作入門」4章 4.3〜を実行します(前編)'")]),e._v(" "),t("ClientOnly",[t("CallInArticleAdsense")],1),e._v(" "),t("p"),t("div",{staticClass:"table-of-contents"},[t("ul",[t("li",[t("a",{attrs:{href:"#pixelwriterクラス-osbook-day04c"}},[e._v("PixelWriterクラス(osbook_day04c)")]),t("ul",[t("li",[t("a",{attrs:{href:"#pixelwriterクラスの実装"}},[e._v("PixelWriterクラスの実装")])]),t("li",[t("a",{attrs:{href:"#pixelwriterクラスの継承"}},[e._v("PixelWriterクラスの継承")])]),t("li",[t("a",{attrs:{href:"#pixelwriterクラスの使い方"}},[e._v("PixelWriterクラスの使い方")])]),t("li",[t("a",{attrs:{href:"#配置newの演算子の定義"}},[e._v("配置newの演算子の定義")])]),t("li",[t("a",{attrs:{href:"#ビルド"}},[e._v("ビルド")])]),t("li",[t("a",{attrs:{href:"#hello-world"}},[e._v("Hello world")])])])]),t("li",[t("a",{attrs:{href:"#ローダの改良-osbook-day04d"}},[e._v("ローダの改良(osbook_day04d)")]),t("ul",[t("li",[t("a",{attrs:{href:"#_64ビット-elf-のファイルヘッダの作成"}},[e._v("64ビット ELF　のファイルヘッダの作成")])]),t("li",[t("a",{attrs:{href:"#カーネルファイルの読み込み-main-c-p113"}},[e._v("カーネルファイルの読み込み(Main.c)p113")])])])]),t("li",[t("a",{attrs:{href:"#まとめ"}},[e._v("まとめ")])]),t("li",[t("a",{attrs:{href:"#参考サイト"}},[e._v("参考サイト")])])])]),t("p"),e._v(" "),t("p",[t("a",{attrs:{href:"//af.moshimo.com/af/c/click?a_id=2604050&p_id=1555&pc_id=2816&pl_id=29835&guid=ON",rel:"nofollow",referrerpolicy:"no-referrer-when-downgrade"}},[t("img",{staticStyle:{border:"none"},attrs:{src:"//image.moshimo.com/af-img/0866/000000029835.jpg",width:"728",height:"90"}})]),t("img",{staticStyle:{border:"none"},attrs:{src:"//i.moshimo.com/af/i/impression?a_id=2604050&p_id=1555&pc_id=2816&pl_id=29835",width:"1",height:"1"}})]),e._v(" "),t("p",[t("a",{attrs:{href:"//af.moshimo.com/af/c/click?a_id=2641145&p_id=1770&pc_id=3386&pl_id=25847&guid=ON",rel:"nofollow",referrerpolicy:"no-referrer-when-downgrade"}},[t("img",{staticStyle:{border:"none"},attrs:{src:"//image.moshimo.com/af-img/1115/000000025847.png",width:"728",height:"90"}})]),t("img",{staticStyle:{border:"none"},attrs:{src:"//i.moshimo.com/af/i/impression?a_id=2641145&p_id=1770&pc_id=3386&pl_id=25847",width:"1",height:"1"}})]),e._v(" "),t("p",[t("img",{staticClass:"lazy",attrs:{alt:"","data-src":"image/WritePixel_4_2.png",loading:"lazy"}})]),e._v(" "),t("h2",{attrs:{id:"pixelwriterクラス-osbook-day04c"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#pixelwriterクラス-osbook-day04c"}},[e._v("#")]),e._v(" PixelWriterクラス(osbook_day04c)")]),e._v(" "),t("h3",{attrs:{id:"pixelwriterクラスの実装"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#pixelwriterクラスの実装"}},[e._v("#")]),e._v(" PixelWriterクラスの実装")]),e._v(" "),t("p",[e._v("mikanos/kernel/main.cppに下記の内容を追記します．")]),e._v(" "),t("div",{staticClass:"language-c++ extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("class PixelWriter{\n  public:\n    PixelWriter(const FrameBufferConfig& config) : config_{config} {\n    }\n    virtual ~PixelWriter() = default;\n    virtual void Write(int x, int y, const PixelColor& c) = 0;\n\n  protected:\n    uint8_t* PixelAt(int x, int y) {\n      return config_.frame_buffer + 4 * (config_.pixels_per_scan_line * y + x);\n    }\n  \n  private:\n    const FrameBufferConfig& config_;\n};\n")])])]),t("h3",{attrs:{id:"pixelwriterクラスの継承"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#pixelwriterクラスの継承"}},[e._v("#")]),e._v(" PixelWriterクラスの継承")]),e._v(" "),t("p",[e._v("mikanos/kernel/main.cppに，PixelWriterクラスで画面に描画する内容を追記します．")]),e._v(" "),t("div",{staticClass:"language-c++ extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("class RGBResv8BitPerColorPixelWriter : public PixelWriter {\n  public:\n    using PixelWriter::PixelWriter;\n\n    virtual void Write(int x, int y, const PixelColor& c) override {\n      auto p = PixelAt(x, y);\n      p[0] = c.r;\n      p[1] = c.g;\n      p[2] = c.b;\n    }\n};\n\nclass BGRResv8BitPerColorPixelWriter : public PixelWriter {\n  public:\n    using PixelWriter::PixelWriter;\n\n    virtual void Write(int x, int y, const PixelColor& c) override {\n      auto p = PixelAt(x, y);\n      p[0] = c.b;\n      p[1] = c.g;\n      p[2] = c.r;\n    }\n};\n")])])]),t("h3",{attrs:{id:"pixelwriterクラスの使い方"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#pixelwriterクラスの使い方"}},[e._v("#")]),e._v(" PixelWriterクラスの使い方")]),e._v(" "),t("p",[e._v("mikanos/kernel/main.cppに，PixelWriterクラスを使う内容を追記します．")]),e._v(" "),t("div",{staticClass:"language-c++ extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v('// PixelWriterポインタの定義\nchar pixel_writer_buf[sizeof(RGBResv8BitPerColorPixelWriter)];\nPixelWriter* pixel_writer;\n\n// PixelWriterクラスの使い方\nextern "C" void KernelMain(const FrameBufferConfig& frame_buffer_config) {\n  switch (frame_buffer_config.pixel_format) {\n    case kPixelRGBResv8BitPerColor:\n      pixel_writer = new(pixel_writer_buf)\n        RGBResv8BitPerColorPixelWriter(frame_buffer_config);\n      break;\n    case kPixelBGRResv8BitPerColor:\n      pixel_writer = new(pixel_writer_buf)\n        BGRResv8BitPerColorPixelWriter(frame_buffer_config);\n      break;\n  }\n\n  for (int x = 0; x < frame_buffer_config.horizontal_resolution; ++x){\n    for (int y = 0; y < frame_buffer_config.vertical_resolution; ++y){\n      pixel_writer->Write(x, y, {255, 255, 255});\n    }\n  }\n  for (int x = 0; x < 200; ++x){\n    for (int y = 0; y < 100; ++y){\n      pixel_writer->Write(x, y, {0, 255, 0});\n    }\n  }\n  while (1) __asm__("hlt");\n}\n')])])]),t("h3",{attrs:{id:"配置newの演算子の定義"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置newの演算子の定義"}},[e._v("#")]),e._v(" 配置newの演算子の定義")]),e._v(" "),t("p",[e._v("mikanos/kernel/main.cppに，配置newの演算子の定義を追記します．")]),e._v(" "),t("p",[e._v("下記の配置newは，メモリ領域の確保を実施しない．")]),e._v(" "),t("div",{staticClass:"language-c++ extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("void* operator new(size_t size, void* buf) {\n  return buf;\n}\n\nvoid operator delete(void* obj) noexcept {\n}\n")])])]),t("h3",{attrs:{id:"ビルド"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ビルド"}},[e._v("#")]),e._v(" ビルド")]),e._v(" "),t("p",[e._v("下記のコードで変更したmain.cpp等を反映します．")]),e._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("source")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token environment constant"}},[e._v("$HOME")]),e._v("/osbook/devenv/buildenv.sh\n\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("cd")]),e._v(" ~/workspaces/mikanos-devcontainer/mikanos/kernel\n"),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("make")]),e._v("\n\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("cd")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token environment constant"}},[e._v("$HOME")]),e._v("/edk2/\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("source")]),e._v(" edksetup.sh\nbuild\n")])])]),t("h3",{attrs:{id:"hello-world"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#hello-world"}},[e._v("#")]),e._v(" Hello world")]),e._v(" "),t("p",[e._v("下記のコードでイメージファイルを上書きし，Hello Worldを実行します．")]),e._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("cd")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token environment constant"}},[e._v("$HOME")]),e._v("/edk2\n\n"),t("span",{pre:!0,attrs:{class:"token environment constant"}},[e._v("$HOME")]),e._v("/osbook/devenv/run_qemu.sh Build/MikanLoaderX64/DEBUG_CLANG38/X64/Loader.efi "),t("span",{pre:!0,attrs:{class:"token environment constant"}},[e._v("$HOME")]),e._v("/workspaces/mikanos-devcontainer/mikanos/kernel/kernel.elf\n")])])]),t("p",[t("img",{staticClass:"lazy",attrs:{alt:"","data-src":"image/mikanos/WritePixel_4_3.png",loading:"lazy"}})]),e._v(" "),t("h2",{attrs:{id:"ローダの改良-osbook-day04d"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ローダの改良-osbook-day04d"}},[e._v("#")]),e._v(" ローダの改良(osbook_day04d)")]),e._v(" "),t("p",[e._v("今までの描画プログラムには，下記のバグが存在します．")]),e._v(" "),t("p",[e._v("カーネルの読み込むためのメモリ確保において，メモリの大きさを計算する処理が間違っている．")]),e._v(" "),t("div",{staticClass:"language-c++ extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("cd ~/workspaces/mikanos-devcontainer/mikanos/kernel\nreadelf -l kernel.elf\n\n// Elf file type is EXEC (Executable file)\n// Entry point 0x101020\n// There are 5 program headers, starting at offset 64\n\n// Program Headers:\n//   Type           Offset             VirtAddr           PhysAddr\n//                  FileSiz            MemSiz              Flags  Align\n//   PHDR           0x0000000000000040 0x0000000000100040 0x0000000000100040\n//                  0x0000000000000118 0x0000000000000118  R      0x8\n//   LOAD           0x0000000000000000 0x0000000000100000 0x0000000000100000\n//                  0x00000000000001a8 0x00000000000001a8  R      0x1000\n//   LOAD           0x0000000000001000 0x0000000000101000 0x0000000000101000\n//                  0x00000000000001b9 0x00000000000001b9  R E    0x1000\n//   LOAD           0x0000000000002000 0x0000000000102000 0x0000000000102000\n//                  0x0000000000000000 0x0000000000000018  RW     0x1000\n//   GNU_STACK      0x0000000000000000 0x0000000000000000 0x0000000000000000\n//                  0x0000000000000000 0x0000000000000000  RW     0x0\n\n//  Section to Segment mapping:\n//   Segment Sections...\n//    00     \n//    01     .rodata \n//    02     .text \n//    03     .bss \n//    04   \n")])])]),t("h3",{attrs:{id:"_64ビット-elf-のファイルヘッダの作成"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_64ビット-elf-のファイルヘッダの作成"}},[e._v("#")]),e._v(" 64ビット ELF　のファイルヘッダの作成")]),e._v(" "),t("p",[e._v("mikanos/kernel/elf.hppに64ビット_ELFのファイルヘッダを追記します．")]),e._v(" "),t("div",{staticClass:"language-c++ extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("#define EI_NINDENT 16\n\ntypedef struct {\n  unsigned char e_indent[EI_NINDENT]:\n  Elf64_Half e_type;\n  Elf64_Half e_machine;\n  Elf64_Word e_version;\n  Elf64_Addr e_entry;\n  Elf64_Off  e_phoff;\n  Elf64_Off  e_shoff;\n  Elf64_Word e_flags;\n  Elf64_Half e_ehsize;\n  Elf64_Half e_phentsize;\n  Elf64_Half e_phnum;\n  Elf64_Half e_shentsize;\n  Elf64_Half e_shnum;\n  Elf64_Half shstrndx;\n} Elf64_Endr;\n")])])]),t("h3",{attrs:{id:"カーネルファイルの読み込み-main-c-p113"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#カーネルファイルの読み込み-main-c-p113"}},[e._v("#")]),e._v(" カーネルファイルの読み込み(Main.c)p113")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("\n")])])]),t("h2",{attrs:{id:"まとめ"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#まとめ"}},[e._v("#")]),e._v(" まとめ")]),e._v(" "),t("p",[e._v("「ゼロからのOS自作入門」4章 4.3〜を実行しました(前編)．")]),e._v(" "),t("h2",{attrs:{id:"参考サイト"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#参考サイト"}},[e._v("#")]),e._v(" 参考サイト")]),e._v(" "),t("p",[t("a",{attrs:{href:"https://noanoa07.livedoor.blog/archives/2342461.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("『ゼロからのOS自作入門』をMacで動かしてみた記録（第4章 4.2 osbook_day04b）"),t("OutboundLink")],1)]),e._v(" "),t("p",[t("a",{attrs:{href:"//af.moshimo.com/af/c/click?a_id=2604050&p_id=1555&pc_id=2816&pl_id=29835&guid=ON",rel:"nofollow",referrerpolicy:"no-referrer-when-downgrade"}},[t("img",{staticStyle:{border:"none"},attrs:{src:"//image.moshimo.com/af-img/0866/000000029835.jpg",width:"728",height:"90"}})]),t("img",{staticStyle:{border:"none"},attrs:{src:"//i.moshimo.com/af/i/impression?a_id=2604050&p_id=1555&pc_id=2816&pl_id=29835",width:"1",height:"1"}})]),e._v(" "),t("p",[t("a",{attrs:{href:"//af.moshimo.com/af/c/click?a_id=2641145&p_id=1770&pc_id=3386&pl_id=25847&guid=ON",rel:"nofollow",referrerpolicy:"no-referrer-when-downgrade"}},[t("img",{staticStyle:{border:"none"},attrs:{src:"//image.moshimo.com/af-img/1115/000000025847.png",width:"728",height:"90"}})]),t("img",{staticStyle:{border:"none"},attrs:{src:"//i.moshimo.com/af/i/impression?a_id=2641145&p_id=1770&pc_id=3386&pl_id=25847",width:"1",height:"1"}})]),e._v(" "),t("ClientOnly",[t("CallInArticleAdsense")],1)],1)}),[],!1,null,null,null);r.default=i.exports}}]);
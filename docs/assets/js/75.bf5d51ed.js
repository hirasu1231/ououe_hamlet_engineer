(window.webpackJsonp=window.webpackJsonp||[]).push([[75],{462:function(t,s,a){"use strict";a.r(s);var n=a(2),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("p",[t._v("igQueryでプローブデータの来訪順を考慮した滞在スポットごとにIDを振ります．")]),t._v(" "),a("p",[t._v("注意:かなりゴリ押しでIDを振りました。他に良い手法があればご教授ください。\n")]),t._v(" "),a("ClientOnly",[a("CallInArticleAdsense")],1),t._v(" "),a("p"),a("div",{staticClass:"table-of-contents"},[a("ul",[a("li",[a("a",{attrs:{href:"#ライブラリのインストール"}},[t._v("ライブラリのインストール")])]),a("li",[a("a",{attrs:{href:"#架空の行動履歴データの作成"}},[t._v("架空の行動履歴データの作成")])]),a("li",[a("a",{attrs:{href:"#テーブルの作成"}},[t._v("テーブルの作成")]),a("ul",[a("li",[a("a",{attrs:{href:"#bigqueryと接続"}},[t._v("BigQueryと接続")])]),a("li",[a("a",{attrs:{href:"#データセットの生成"}},[t._v("データセットの生成")])]),a("li",[a("a",{attrs:{href:"#テーブルの作成とdfの格納"}},[t._v("テーブルの作成とdfの格納")])]),a("li",[a("a",{attrs:{href:"#テーブルの確認"}},[t._v("テーブルの確認")])])])]),a("li",[a("a",{attrs:{href:"#来訪順を考慮した滞在スポットごとにid配布"}},[t._v("来訪順を考慮した滞在スポットごとにID配布")]),a("ul",[a("li",[a("a",{attrs:{href:"#各行に次の行動データを追加-lag-lead関数"}},[t._v("各行に次の行動データを追加(LAG/LEAD関数)")])]),a("li",[a("a",{attrs:{href:"#次の行動より、滞在する-stay-or-移動する-move-を明示"}},[t._v("次の行動より、滞在する(stay) or 移動する(move)　を明示")])]),a("li",[a("a",{attrs:{href:"#行動id-behavior-id-を配布する"}},[t._v("行動ID(behavior_id)を配布する")])]),a("li",[a("a",{attrs:{href:"#行動id-behavior-id-ごとに集計"}},[t._v("行動ID(behavior_id)ごとに集計")])])])]),a("li",[a("a",{attrs:{href:"#参考サイト"}},[t._v("参考サイト")])])])]),a("p"),t._v(" "),a("h2",{attrs:{id:"ライブラリのインストール"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ライブラリのインストール"}},[t._v("#")]),t._v(" ライブラリのインストール")]),t._v(" "),a("div",{staticClass:"language-python extra-class"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[t._v("!pip install "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("upgrade pandas"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("gbq "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'google-cloud-bigquery[bqstorage,pandas]'")]),t._v("\n")])])]),a("h2",{attrs:{id:"架空の行動履歴データの作成"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#架空の行動履歴データの作成"}},[t._v("#")]),t._v(" 架空の行動履歴データの作成")]),t._v(" "),a("p",[t._v("仮のデータを作成します。")]),t._v(" "),a("div",{staticClass:"language-python extra-class"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" random\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" datetime\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" pandas "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" pd\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 重複なしランダム発生")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("rand_ints_nodup")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" b"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" k"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    ns "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("len")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ns"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" k"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        n "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" random"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("randint"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" b"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("not")]),t._v(" n "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" ns"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            ns"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("append"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" ns\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 架空の行動履歴作成")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("make_probe")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("_list"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" e"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" _id "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("range")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" e"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 立ち寄りスポット数")]),t._v("\n        spot_num "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" random"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("randint"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 立ち寄りスポットリスト")]),t._v("\n        spot_list "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" rand_ints_nodup"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" spot_num"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 日付")]),t._v("\n        dt "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" datetime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("datetime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2018")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("9")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("15")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("30")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 日にち加算")]),t._v("\n        dp "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" random"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("randint"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("20")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        dt "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" dt "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" datetime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("timedelta"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("days"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("dp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        date "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("str")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("split"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'-'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("str")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("split"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'-'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("split"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("' '")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 時刻加算")]),t._v("\n        hp "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" random"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("randint"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        dt "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" dt "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" datetime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("timedelta"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("hours"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("hp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" spot "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" spot_list"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            tflag "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n            n "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" random"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("randint"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v(" n "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" tflag"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n                tflag "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n                mims "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" random"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("randint"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n                dt "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" dt "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" datetime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("timedelta"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("minutes"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("mims"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n                _list"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("append"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("date"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" _id"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" dt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string-interpolation"}},[a("span",{pre:!0,attrs:{class:"token string"}},[t._v("f'spot_")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("spot"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" _list\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 行動履歴作成")]),t._v("\nprobe_list "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\nprobe_list "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" make_probe"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("probe_list"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("400")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nprobe_list "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" make_probe"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("probe_list"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("30")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("140")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# データフレーム化")]),t._v("\ndf "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" pd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DataFrame"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("probe_list"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" columns"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'date'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'id'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'time'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'spot'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ndisplay"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("df"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("h2",{attrs:{id:"テーブルの作成"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#テーブルの作成"}},[t._v("#")]),t._v(" テーブルの作成")]),t._v(" "),a("h3",{attrs:{id:"bigqueryと接続"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#bigqueryと接続"}},[t._v("#")]),t._v(" BigQueryと接続")]),t._v(" "),a("div",{staticClass:"language-python extra-class"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" google"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cloud "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" bigquery\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# keyとなるjsonファイルを読み込み")]),t._v("\nKEY_PATH "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'＊＊＊＊＊＊.json'")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# KEY_PATH = '****.json'")]),t._v("\n\nbq_client "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" bigquery"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("from_service_account_json"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("KEY_PATH"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("h3",{attrs:{id:"データセットの生成"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#データセットの生成"}},[t._v("#")]),t._v(" データセットの生成")]),t._v(" "),a("div",{staticClass:"language-python extra-class"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# データセットの生成")]),t._v("\ndataset_id "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'sample_data'")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    bq_client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("create_dataset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dataset_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("except")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("print")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Existed"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" ds "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" bq_client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("list_datasets"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("print")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ds"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dataset_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("h3",{attrs:{id:"テーブルの作成とdfの格納"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#テーブルの作成とdfの格納"}},[t._v("#")]),t._v(" テーブルの作成とdfの格納")]),t._v(" "),a("div",{staticClass:"language-python extra-class"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" google"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cloud "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" bigquery\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" time \n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# pandasからBQスキーマを作成")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("bq_mkschema")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("schema_df"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# データ型の確認")]),t._v("\n    df_columns "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" schema_df"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dtypes\n    df_columns "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" pd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DataFrame"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("df_columns"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("reset_index"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    df_columns "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" df_columns"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("rename"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("columns"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'index'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'columns'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'type'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# スキーマ作成")]),t._v("\n    schema "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" i "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("range")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("len")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("df_columns"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        column "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" df_columns"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'columns'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("i"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n        dtype "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("str")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("df_columns"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'type'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("i"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("replace"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'datetime64[ns]'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'DATETIME'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\\\n                                          "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("replace"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'int64'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'INTEGER'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\\\n                                          "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("replace"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'INT64'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'INTEGER'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\\\n                                          "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("replace"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'object'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'STRING'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        schema"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("append"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("bigquery"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("SchemaField"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("column"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" dtype"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" mode"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"NULLABLE"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    \n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" schema\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# BQでテーブルの存在確認")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("exist_tabel")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("exist_table_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" table_name "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("table"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("table_id "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" table "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" bq_client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("list_tables"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dataset"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("dataset_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    \n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# BQでテーブル情報作成")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("bq_table_info")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("table_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" table_schema"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# テーブル名")]),t._v("\n    dataset "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" bq_client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("get_dataset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dataset_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    table_id "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'%s.%s.%s'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("%")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dataset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("project"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" dataset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dataset_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" table_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    \n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# テーブル情報")]),t._v("\n    table_info "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" bigquery"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Table"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("table_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" schema"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("table_schema"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# テーブル生成")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("not")]),t._v(" exist_tabel"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("table_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        bq_client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("create_table"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("table_info"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" table_info\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# pandasからBQに格納")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("bq_insert_pandas")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("insert_df"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" insert_table_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# スキーマ作成")]),t._v("\n    insert_schema "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" bq_mkschema"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("insert_df"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# テーブル情報取得")]),t._v("\n    insert_table_info "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" bq_table_info"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("insert_table_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" insert_schema"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("not")]),t._v(" exist_tabel"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("insert_table_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("continue")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# DataFrameを投入")]),t._v("\n    bq_client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("insert_rows_from_dataframe"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("insert_table_info"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" insert_df"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    \n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# pandasからBQに格納")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("bq_update_pandas")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("update_df"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" update_table_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# テーブル削除")]),t._v("\n    dataset "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" bq_client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("get_dataset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dataset_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    table "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" dataset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("table"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("update_table_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    bq_client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("delete_table"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("table"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    time"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sleep"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# スキーマ作成")]),t._v("\n    update_schema "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" bq_mkschema"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("update_df"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# テーブル情報取得")]),t._v("\n    update_table_info "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" bq_table_info"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("update_table_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" update_schema"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("not")]),t._v(" exist_tabel"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("update_table_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("continue")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# DataFrameを投入")]),t._v("\n    bq_client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("insert_rows_from_dataframe"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("update_table_info"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" update_df"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("div",{staticClass:"language-python extra-class"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# pandasからBQに格納")]),t._v("\nbq_insert_pandas"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("df"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"probe_table"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("h3",{attrs:{id:"テーブルの確認"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#テーブルの確認"}},[t._v("#")]),t._v(" テーブルの確認")]),t._v(" "),a("div",{staticClass:"language-python extra-class"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" pandas "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" pd\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# テーブル名")]),t._v("\ntable_name "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"probe_table"')]),t._v("\ndataset "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" bq_client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("get_dataset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dataset_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ntable_id "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'%s.%s.%s'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("%")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dataset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("project"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" dataset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dataset_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" table_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# クエリ")]),t._v("\nquery "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string-interpolation"}},[a("span",{pre:!0,attrs:{class:"token string"}},[t._v("f'''SELECT * \n            FROM ")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("table_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'''")])]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# strベースのクエリと、project_idが必要")]),t._v("\ndf_gbq "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" pd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("read_gbq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("query"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" table_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("split"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"."')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ndisplay"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("df_gbq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("table",[a("thead",[a("tr",[a("th",[t._v("date")]),t._v(" "),a("th",[t._v("id")]),t._v(" "),a("th",[t._v("time")]),t._v(" "),a("th",[t._v("spot")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("0206")]),t._v(" "),a("td",[t._v("1")]),t._v(" "),a("td",[t._v("2018-02-06 15:18:30")]),t._v(" "),a("td",[t._v("spot_4")])]),t._v(" "),a("tr",[a("td",[t._v("0206")]),t._v(" "),a("td",[t._v("1")]),t._v(" "),a("td",[t._v("2018-02-06 15:20:30")]),t._v(" "),a("td",[t._v("spot_4")])])])]),t._v(" "),a("h2",{attrs:{id:"来訪順を考慮した滞在スポットごとにid配布"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#来訪順を考慮した滞在スポットごとにid配布"}},[t._v("#")]),t._v(" 来訪順を考慮した滞在スポットごとにID配布")]),t._v(" "),a("p",[t._v("ID配布の工程を下記に示します。")]),t._v(" "),a("ol",[a("li",[t._v("各行に次の行動データを追加(LAG/LEAD関数)")]),t._v(" "),a("li",[t._v("次の行動より、滞在する(stay) or 移動する(move)　を明示")]),t._v(" "),a("li",[t._v("行動ID(behavior_id)を配布する")]),t._v(" "),a("li",[t._v("行動ID(behavior_id)ごとに集計")])]),t._v(" "),a("h3",{attrs:{id:"各行に次の行動データを追加-lag-lead関数"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#各行に次の行動データを追加-lag-lead関数"}},[t._v("#")]),t._v(" 各行に次の行動データを追加(LAG/LEAD関数)")]),t._v(" "),a("ul",[a("li",[t._v("LAG(column, 1):1行分くり下げる")]),t._v(" "),a("li",[t._v("LEAD(column, 1):1行分くり上げる")])]),t._v(" "),a("h4",{attrs:{id:"クエリの実行"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#クエリの実行"}},[t._v("#")]),t._v(" クエリの実行")]),t._v(" "),a("div",{staticClass:"language-python extra-class"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" pandas "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" pd\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# テーブル名")]),t._v("\ntable_name "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"probe_table"')]),t._v("\ndataset "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" bq_client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("get_dataset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dataset_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ntable_id "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'%s.%s.%s'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("%")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dataset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("project"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" dataset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dataset_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" table_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\nquery "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string-interpolation"}},[a("span",{pre:!0,attrs:{class:"token string"}},[t._v("f'''\n        SELECT \n            * ,\n            LEAD(time, 1) OVER (PARTITION BY date, id ORDER BY id, time) AS next_time,\n            LEAD(spot, 1) OVER (PARTITION BY date, id ORDER BY id, time) AS next_spot\n        FROM \n            ")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("table_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("\n        ORDER BY date, id, time\n        '''")])]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# strベースのクエリと、project_idが必要")]),t._v("\ndf_lag "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" pd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("read_gbq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("query"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" table_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("split"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"."')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ndisplay"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("df_lag"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("table",[a("thead",[a("tr",[a("th",[t._v("date")]),t._v(" "),a("th",[t._v("id")]),t._v(" "),a("th",[t._v("time")]),t._v(" "),a("th",[t._v("spot")]),t._v(" "),a("th",[t._v("next_time")]),t._v(" "),a("th",[t._v("next_spot")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("0202")]),t._v(" "),a("td",[t._v("26")]),t._v(" "),a("td",[t._v("2018-02-02 15:19:30")]),t._v(" "),a("td",[t._v("spot_1")]),t._v(" "),a("td",[t._v("2018-02-02 15:23:30")]),t._v(" "),a("td",[t._v("spot_1")])]),t._v(" "),a("tr",[a("td",[t._v("0202")]),t._v(" "),a("td",[t._v("26")]),t._v(" "),a("td",[t._v("2018-02-02 15:23:30")]),t._v(" "),a("td",[t._v("spot_1")]),t._v(" "),a("td",[t._v("2018-02-02 15:24:30")]),t._v(" "),a("td",[t._v("spot_1")])])])]),t._v(" "),a("h4",{attrs:{id:"データ型の確認と変更"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#データ型の確認と変更"}},[t._v("#")]),t._v(" データ型の確認と変更")]),t._v(" "),a("p",[t._v("Int64ではエラーが出るので、int64に変更します")]),t._v(" "),a("div",{staticClass:"language-python extra-class"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Int64 -> int64")]),t._v("\ndf_lag"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"id"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" df_lag"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"id"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("astype"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'int'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ndisplay"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("df_lag"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dtypes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# date                 object")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# id                    int64")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# time         datetime64[ns]")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# spot                 object")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# next_time    datetime64[ns]")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# next_spot            object")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# dtype: object")]),t._v("\n")])])]),a("h4",{attrs:{id:"bqに格納"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#bqに格納"}},[t._v("#")]),t._v(" BQに格納")]),t._v(" "),a("p",[t._v("下記のコードで新たにテーブルを作成します。")]),t._v(" "),a("div",{staticClass:"language-python extra-class"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# pandasからBQに格納")]),t._v("\nbq_insert_pandas"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("df_lag"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"prep_table"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("h3",{attrs:{id:"次の行動より、滞在する-stay-or-移動する-move-を明示"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#次の行動より、滞在する-stay-or-移動する-move-を明示"}},[t._v("#")]),t._v(" 次の行動より、滞在する(stay) or 移動する(move)　を明示")]),t._v(" "),a("h4",{attrs:{id:"クエリの実行-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#クエリの実行-2"}},[t._v("#")]),t._v(" クエリの実行")]),t._v(" "),a("div",{staticClass:"language-python extra-class"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" pandas "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" pd\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# テーブル名")]),t._v("\ntable_name "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"prep_table"')]),t._v("\ndataset "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" bq_client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("get_dataset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dataset_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ntable_id "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'%s.%s.%s'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("%")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dataset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("project"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" dataset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dataset_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" table_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\nquery "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string-interpolation"}},[a("span",{pre:!0,attrs:{class:"token string"}},[t._v("f'''\n        SELECT \n            *,\n        CASE \n            WHEN spot=next_spot THEN 1\n            ELSE 0\n            END\n        AS stay_flag,\n        FROM \n            ")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("table_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("\n        WHERE \n            next_time is not null \n        ORDER BY date, id, time\n        '''")])]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# strベースのクエリと、project_idが必要")]),t._v("\ndf_behavior "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" pd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("read_gbq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("query"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" table_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("split"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"."')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ndisplay"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("df_behavior"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("table",[a("thead",[a("tr",[a("th",[t._v("date")]),t._v(" "),a("th",[t._v("id")]),t._v(" "),a("th",[t._v("time")]),t._v(" "),a("th",[t._v("spot")]),t._v(" "),a("th",[t._v("next_time")]),t._v(" "),a("th",[t._v("next_spot")]),t._v(" "),a("th",[t._v("stay_flag")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("0202")]),t._v(" "),a("td",[t._v("26")]),t._v(" "),a("td",[t._v("2018-02-02 15:19:30")]),t._v(" "),a("td",[t._v("spot_1")]),t._v(" "),a("td",[t._v("2018-02-02 15:23:30")]),t._v(" "),a("td",[t._v("spot_1")]),t._v(" "),a("td",[t._v("1")])]),t._v(" "),a("tr",[a("td",[t._v("0202")]),t._v(" "),a("td",[t._v("26")]),t._v(" "),a("td",[t._v("2018-02-02 15:23:30")]),t._v(" "),a("td",[t._v("spot_1")]),t._v(" "),a("td",[t._v("2018-02-02 15:24:30")]),t._v(" "),a("td",[t._v("spot_1")]),t._v(" "),a("td",[t._v("1")])])])]),t._v(" "),a("h4",{attrs:{id:"データ型の確認と変更-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#データ型の確認と変更-2"}},[t._v("#")]),t._v(" データ型の確認と変更")]),t._v(" "),a("p",[t._v("Int64ではエラーが出るので、int64に変更します")]),t._v(" "),a("div",{staticClass:"language-python extra-class"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Int64 -> int64")]),t._v("\ndf_behavior"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"id"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" df_behavior"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"id"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("astype"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'int'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ndf_behavior"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"stay_flag"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" df_behavior"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"stay_flag"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("astype"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'int'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ndisplay"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("df_behavior"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dtypes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# date                 object")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# id                    int64")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# time         datetime64[ns]")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# spot                 object")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# next_time    datetime64[ns]")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# next_spot            object")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# stay_flag             int64")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# dtype: object")]),t._v("\n")])])]),a("h4",{attrs:{id:"bqに格納-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#bqに格納-2"}},[t._v("#")]),t._v(" BQに格納")]),t._v(" "),a("p",[t._v("下記のコードで新たにテーブルを作成します。")]),t._v(" "),a("div",{staticClass:"language-python extra-class"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# pandasからBQに格納(アップデート)")]),t._v("\nbq_update_pandas"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("df_behavior"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"prep_table"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("div",{staticClass:"language-python extra-class"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# テーブル名")]),t._v("\ntable_name "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"prep_table"')]),t._v("\ndataset "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" bq_client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("get_dataset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dataset_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ntable_id "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'%s.%s.%s'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("%")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dataset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("project"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" dataset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dataset_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" table_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# クエリ")]),t._v("\nquery "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string-interpolation"}},[a("span",{pre:!0,attrs:{class:"token string"}},[t._v("f'''SELECT * \n            FROM ")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("table_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("\n            LIMIT 5'''")])]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# strベースのクエリと、project_idが必要")]),t._v("\ndf_gbq "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" pd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("read_gbq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("query"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" table_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("split"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"."')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ndisplay"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("df_gbq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("h3",{attrs:{id:"行動id-behavior-id-を配布する"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#行動id-behavior-id-を配布する"}},[t._v("#")]),t._v(" 行動ID(behavior_id)を配布する")]),t._v(" "),a("p",[t._v("滞在、移動に切り替わるたびに、振り直されるIDを追記します。")]),t._v(" "),a("h4",{attrs:{id:"移動データの行に移動時の仮id-m-vid-を配布"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#移動データの行に移動時の仮id-m-vid-を配布"}},[t._v("#")]),t._v(" 移動データの行に移動時の仮ID(m_vid)を配布")]),t._v(" "),a("p",[t._v("別spotへ移動する行に、日別のIDごとに10単位で移動時の仮ID(m_vid)を追記します。")]),t._v(" "),a("div",{staticClass:"language-python extra-class"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# テーブル名")]),t._v("\ntable_name "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"prep_table"')]),t._v("\ndataset "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" bq_client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("get_dataset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dataset_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ntable_id "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'%s.%s.%s'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("%")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dataset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("project"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" dataset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dataset_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" table_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# クエリ")]),t._v("\nquery "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string-interpolation"}},[a("span",{pre:!0,attrs:{class:"token string"}},[t._v("f'''\n    SELECT \n        *,\n        ROW_NUMBER() OVER(PARTITION BY date, id ORDER BY time, id)*10 m_vid\n    FROM \n        ")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("table_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("\n    WHERE \n        stay_flag=0\n    ORDER BY date, id, time\n    '''")])]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# strベースのクエリと、project_idが必要")]),t._v("\ndf_gbq "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" pd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("read_gbq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("query"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" table_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("split"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"."')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ndisplay"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("df_gbq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("table",[a("thead",[a("tr",[a("th",[t._v("date")]),t._v(" "),a("th",[t._v("id")]),t._v(" "),a("th",[t._v("time")]),t._v(" "),a("th",[t._v("spot")]),t._v(" "),a("th",[t._v("next_time")]),t._v(" "),a("th",[t._v("next_spot")]),t._v(" "),a("th",[t._v("stay_flag")]),t._v(" "),a("th",[t._v("m_vid")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("0202")]),t._v(" "),a("td",[t._v("26")]),t._v(" "),a("td",[t._v("2018-02-02 15:34:30")]),t._v(" "),a("td",[t._v("spot_1")]),t._v(" "),a("td",[t._v("2018-02-02 15:36:30")]),t._v(" "),a("td",[t._v("spot_2")]),t._v(" "),a("td",[t._v("0")]),t._v(" "),a("td",[t._v("10")])]),t._v(" "),a("tr",[a("td",[t._v("0202")]),t._v(" "),a("td",[t._v("26")]),t._v(" "),a("td",[t._v("2018-02-02 16:08:30")]),t._v(" "),a("td",[t._v("spot_2")]),t._v(" "),a("td",[t._v("2018-02-02 16:12:30")]),t._v(" "),a("td",[t._v("spot_4")]),t._v(" "),a("td",[t._v("0")]),t._v(" "),a("td",[t._v("20")])]),t._v(" "),a("tr",[a("td",[t._v("0202")]),t._v(" "),a("td",[t._v("51")]),t._v(" "),a("td",[t._v("2018-02-02 13:28:30")]),t._v(" "),a("td",[t._v("spot_5")]),t._v(" "),a("td",[t._v("2018-02-02 13:32:30")]),t._v(" "),a("td",[t._v("spot_1")]),t._v(" "),a("td",[t._v("0")]),t._v(" "),a("td",[t._v("10")])])])]),t._v(" "),a("h4",{attrs:{id:"滞在データの行に滞在時の仮id-s-vid-を配布"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#滞在データの行に滞在時の仮id-s-vid-を配布"}},[t._v("#")]),t._v(" 滞在データの行に滞在時の仮ID(s_vid)を配布")]),t._v(" "),a("p",[t._v("別spotへ移動する行に、日別のIDごとに10単位で滞在時の仮ID(s_vid)を追記します。")]),t._v(" "),a("div",{staticClass:"language-python extra-class"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# テーブル名")]),t._v("\ntable_name "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"prep_table"')]),t._v("\ndataset "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" bq_client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("get_dataset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dataset_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ntable_id "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'%s.%s.%s'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("%")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dataset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("project"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" dataset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dataset_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" table_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# クエリ")]),t._v("\nquery "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string-interpolation"}},[a("span",{pre:!0,attrs:{class:"token string"}},[t._v("f'''\n    SELECT \n        *,\n        CASE WHEN stay_flag=1 THEN 5 ELSE 0 END AS s_vid,\n    FROM \n        ")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("table_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("\n    ORDER BY date, id, time\n    '''")])]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# strベースのクエリと、project_idが必要")]),t._v("\ndf_gbq "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" pd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("read_gbq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("query"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" table_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("split"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"."')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ndisplay"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("df_gbq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("table",[a("thead",[a("tr",[a("th",[t._v("date")]),t._v(" "),a("th",[t._v("id")]),t._v(" "),a("th",[t._v("time")]),t._v(" "),a("th",[t._v("spot")]),t._v(" "),a("th",[t._v("next_time")]),t._v(" "),a("th",[t._v("next_spot")]),t._v(" "),a("th",[t._v("stay_flag")]),t._v(" "),a("th",[t._v("s_vid")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("0202")]),t._v(" "),a("td",[t._v("26")]),t._v(" "),a("td",[t._v("2018-02-02 15:19:30")]),t._v(" "),a("td",[t._v("spot_1")]),t._v(" "),a("td",[t._v("2018-02-02 15:23:30")]),t._v(" "),a("td",[t._v("spot_1")]),t._v(" "),a("td",[t._v("1")]),t._v(" "),a("td",[t._v("5")])]),t._v(" "),a("tr",[a("td",[t._v("0202")]),t._v(" "),a("td",[t._v("26")]),t._v(" "),a("td",[t._v("2018-02-02 15:23:30")]),t._v(" "),a("td",[t._v("spot_1")]),t._v(" "),a("td",[t._v("2018-02-02 15:24:30")]),t._v(" "),a("td",[t._v("spot_1")]),t._v(" "),a("td",[t._v("1")]),t._v(" "),a("td",[t._v("5")])]),t._v(" "),a("tr",[a("td",[t._v("0202")]),t._v(" "),a("td",[t._v("26")]),t._v(" "),a("td",[t._v("2018-02-02 15:24:30")]),t._v(" "),a("td",[t._v("spot_1")]),t._v(" "),a("td",[t._v("2018-02-02 15:25:30")]),t._v(" "),a("td",[t._v("spot_1")]),t._v(" "),a("td",[t._v("1")]),t._v(" "),a("td",[t._v("5")])])])]),t._v(" "),a("h4",{attrs:{id:"移動-滞在時の仮id-m-vid-s-vid-のテーブルを結合"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#移動-滞在時の仮id-m-vid-s-vid-のテーブルを結合"}},[t._v("#")]),t._v(" 移動/滞在時の仮ID(m_vid/s_vid)のテーブルを結合")]),t._v(" "),a("p",[t._v("移動/滞在時の仮ID(m_vid/s_vid)のテーブルを「LEFT JOIN」で結合させます。")]),t._v(" "),a("div",{staticClass:"language-python extra-class"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# テーブル名")]),t._v("\ntable_name "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"prep_table"')]),t._v("\ndataset "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" bq_client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("get_dataset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dataset_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ntable_id "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'%s.%s.%s'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("%")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dataset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("project"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" dataset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dataset_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" table_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# クエリ")]),t._v("\nquery "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string-interpolation"}},[a("span",{pre:!0,attrs:{class:"token string"}},[t._v("f'''\n    WITH t1 AS(\n    SELECT \n        *,\n        ROW_NUMBER() OVER(PARTITION BY date, id ORDER BY time, id)*10 m_vid\n    FROM \n        ")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("table_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("\n    WHERE \n        stay_flag=0\n    ORDER BY date, id, time),\n    t2 AS(\n    SELECT \n        *,\n        CASE WHEN stay_flag=1 THEN 5 ELSE 0 END AS s_vid,\n    FROM \n        ")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("table_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("\n    ORDER BY date, id, time)\n    SELECT \n        t2.*,\n        t1.m_vid\n    FROM \n        t2 \n    LEFT JOIN \n        t1 \n    ON \n        t2.time = t1.time AND \n        t2.id = t1.id AND \n        t2.spot = t1.spot\n    ORDER BY t2.date, t2.id, t2.time\n    '''")])]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# strベースのクエリと、project_idが必要")]),t._v("\ndf_gbq "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" pd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("read_gbq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("query"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" table_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("split"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"."')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ndisplay"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("df_gbq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("table",[a("thead",[a("tr",[a("th",[t._v("date")]),t._v(" "),a("th",[t._v("id")]),t._v(" "),a("th",[t._v("time")]),t._v(" "),a("th",[t._v("spot")]),t._v(" "),a("th",[t._v("next_time")]),t._v(" "),a("th",[t._v("next_spot")]),t._v(" "),a("th",[t._v("stay_flag")]),t._v(" "),a("th",[t._v("s_vid")]),t._v(" "),a("th",[t._v("m_vid")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("0202")]),t._v(" "),a("td",[t._v("26")]),t._v(" "),a("td",[t._v("2018-02-02 15:19:30")]),t._v(" "),a("td",[t._v("spot_1")]),t._v(" "),a("td",[t._v("2018-02-02 15:23:30")]),t._v(" "),a("td",[t._v("spot_1")]),t._v(" "),a("td",[t._v("1")]),t._v(" "),a("td",[t._v("5")]),t._v(" "),a("td",[a("NA")],1)]),t._v(" "),a("tr",[a("td",[t._v("0202")]),t._v(" "),a("td",[t._v("26")]),t._v(" "),a("td",[t._v("2018-02-02 15:23:30")]),t._v(" "),a("td",[t._v("spot_1")]),t._v(" "),a("td",[t._v("2018-02-02 15:24:30")]),t._v(" "),a("td",[t._v("spot_1")]),t._v(" "),a("td",[t._v("1")]),t._v(" "),a("td",[t._v("5")]),t._v(" "),a("td",[a("NA")],1)]),t._v(" "),a("tr",[a("td",[t._v("0202")]),t._v(" "),a("td",[t._v("26")]),t._v(" "),a("td",[t._v("2018-02-02 15:24:30")]),t._v(" "),a("td",[t._v("spot_1")]),t._v(" "),a("td",[t._v("2018-02-02 15:25:30")]),t._v(" "),a("td",[t._v("spot_1")]),t._v(" "),a("td",[t._v("1")]),t._v(" "),a("td",[t._v("5")]),t._v(" "),a("td",[a("NA")],1)])])]),t._v(" "),a("h4",{attrs:{id:"結合後のm-vidをnull補完-1"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#結合後のm-vidをnull補完-1"}},[t._v("#")]),t._v(" 結合後のm_vidをNULL補完_1")]),t._v(" "),a("p",[t._v("結合後のm_vidをFirst_VALUE()でNULL補完します。")]),t._v(" "),a("div",{staticClass:"language-python extra-class"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# NULL, NULL, NULL, 10, NULL, 20, NULL")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#   10,   10,   10, 10,   20, 20, NULL")]),t._v("\n")])])]),a("div",{staticClass:"language-python extra-class"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# テーブル名")]),t._v("\ntable_name "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"prep_table"')]),t._v("\ndataset "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" bq_client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("get_dataset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dataset_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ntable_id "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'%s.%s.%s'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("%")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dataset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("project"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" dataset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dataset_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" table_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# クエリ")]),t._v("\nquery "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string-interpolation"}},[a("span",{pre:!0,attrs:{class:"token string"}},[t._v("f'''\n    WITH t1 AS(\n    SELECT \n        *,\n        ROW_NUMBER() OVER(PARTITION BY date, id ORDER BY time, id)*10 m_vid\n    FROM \n        ")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("table_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("\n    WHERE \n        stay_flag=0\n    ORDER BY date, id, time),\n    t2 AS(\n    SELECT \n        *,\n        CASE WHEN stay_flag=1 THEN 5 ELSE 0 END AS s_vid,\n    FROM \n        ")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("table_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("\n    ORDER BY date, id, time)\n    SELECT \n        t2.*,\n        t1.m_vid,\n        First_VALUE(t1.m_vid IGNORE NULLS) OVER ( \n            PARTITION BY t2.date,t2.id\n            ORDER BY t2.time, t2.id, t2.next_time \n            ROWS BETWEEN CURRENT ROW AND UNBOUNDED FOLLOWING) As FV_num,\n        First_VALUE(t1.m_vid IGNORE NULLS) OVER (\n            PARTITION BY t2.date,t2.id\n            ORDER BY t2.time, t2.id, t2.next_time \n            ROWS BETWEEN CURRENT ROW AND UNBOUNDED FOLLOWING) - t2.s_vid As behavior_id\n    FROM \n        t2 LEFT JOIN t1 \n        ON t2.time = t1.time AND \n        t2.id = t1.id AND \n        t2.spot = t1.spot\n    ORDER BY t2.date, t2.id, t2.time\n    '''")])]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# strベースのクエリと、project_idが必要")]),t._v("\ndf_gbq "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" pd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("read_gbq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("query"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" table_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("split"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"."')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ndisplay"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("df_gbq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("table",[a("thead",[a("tr",[a("th",[t._v("date")]),t._v(" "),a("th",[t._v("id")]),t._v(" "),a("th",[t._v("time")]),t._v(" "),a("th",[t._v("spot")]),t._v(" "),a("th",[t._v("next_time")]),t._v(" "),a("th",[t._v("next_spot")]),t._v(" "),a("th",[t._v("stay_flag")]),t._v(" "),a("th",[t._v("s_vid")]),t._v(" "),a("th",[t._v("m_vid")]),t._v(" "),a("th",[t._v("FV_num")]),t._v(" "),a("th",[t._v("behavior_id")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("0202")]),t._v(" "),a("td",[t._v("26")]),t._v(" "),a("td",[t._v("2018-02-02 15:19:30")]),t._v(" "),a("td",[t._v("spot_1")]),t._v(" "),a("td",[t._v("2018-02-02 15:23:30")]),t._v(" "),a("td",[t._v("spot_1")]),t._v(" "),a("td",[t._v("1")]),t._v(" "),a("td",[t._v("5")]),t._v(" "),a("td",[a("NA")],1),t._v(" "),a("td",[t._v("10")]),t._v(" "),a("td",[t._v("5")])]),t._v(" "),a("tr",[a("td",[t._v("0202")]),t._v(" "),a("td",[t._v("26")]),t._v(" "),a("td",[t._v("2018-02-02 15:23:30")]),t._v(" "),a("td",[t._v("spot_1")]),t._v(" "),a("td",[t._v("2018-02-02 15:24:30")]),t._v(" "),a("td",[t._v("spot_1")]),t._v(" "),a("td",[t._v("1")]),t._v(" "),a("td",[t._v("5")]),t._v(" "),a("td",[a("NA")],1),t._v(" "),a("td",[t._v("10")]),t._v(" "),a("td",[t._v("5")])]),t._v(" "),a("tr",[a("td",[t._v("0202")]),t._v(" "),a("td",[t._v("26")]),t._v(" "),a("td",[t._v("2018-02-02 15:24:30")]),t._v(" "),a("td",[t._v("spot_1")]),t._v(" "),a("td",[t._v("2018-02-02 15:25:30")]),t._v(" "),a("td",[t._v("spot_1")]),t._v(" "),a("td",[t._v("1")]),t._v(" "),a("td",[t._v("5")]),t._v(" "),a("td",[a("NA")],1),t._v(" "),a("td",[t._v("10")]),t._v(" "),a("td",[t._v("5")])])])]),t._v(" "),a("h4",{attrs:{id:"結合後のm-vidをnull補完-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#結合後のm-vidをnull補完-2"}},[t._v("#")]),t._v(" 結合後のm_vidをNULL補完_2")]),t._v(" "),a("p",[t._v("最終滞在spotのm_vidのNULLは補完出来ていないので、IFNULL()でします。(最終滞在spotでは9999とする)")]),t._v(" "),a("div",{staticClass:"language-python extra-class"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#   10,   10,   10, 10,   20, 20, NULL")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#   10,   10,   10, 10,   20, 20, 9999")]),t._v("\n")])])]),a("div",{staticClass:"language-python extra-class"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# テーブル名")]),t._v("\ntable_name "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"prep_table"')]),t._v("\ndataset "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" bq_client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("get_dataset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dataset_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ntable_id "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'%s.%s.%s'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("%")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dataset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("project"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" dataset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dataset_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" table_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# クエリ")]),t._v("\nquery "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string-interpolation"}},[a("span",{pre:!0,attrs:{class:"token string"}},[t._v("f'''\n    WITH t1 AS(\n    SELECT \n        *,\n        ROW_NUMBER() OVER(PARTITION BY date, id ORDER BY time, id)*10 m_vid\n    FROM \n        ")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("table_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("\n    WHERE \n        stay_flag=0\n    ORDER BY date, id, time),\n    t2 AS(\n    SELECT \n        *,\n        CASE WHEN stay_flag=1 THEN 5 ELSE 0 END AS s_vid,\n    FROM \n        ")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("table_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("\n    ORDER BY date, id, time)\n    SELECT \n        t3.date,\n        t3.id, \n        t3.time, \n        t3.spot, \n        t3.next_time, \n        t3.next_spot, \n        t3.stay_flag, \n        IFNULL(t3.behavior_id, 9999) AS behavior_id\n    FROM \n        (SELECT \n            t2.*,\n            t1.m_vid,\n            First_VALUE(t1.m_vid IGNORE NULLS) OVER ( \n                PARTITION BY t2.date,t2.id\n                ORDER BY t2.time, t2.id, t2.next_time \n                ROWS BETWEEN CURRENT ROW AND UNBOUNDED FOLLOWING) As FV_num,\n            First_VALUE(t1.m_vid IGNORE NULLS) OVER (\n                PARTITION BY t2.date,t2.id\n                ORDER BY t2.time, t2.id, t2.next_time \n                ROWS BETWEEN CURRENT ROW AND UNBOUNDED FOLLOWING) - t2.s_vid AS behavior_id\n        FROM \n            t2 \n        LEFT JOIN \n            t1 \n        ON \n            t2.time = t1.time AND \n            t2.id = t1.id AND \n            t2.spot = t1.spot\n        ORDER BY t2.date, t2.id, t2.time) AS t3\n    '''")])]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# strベースのクエリと、project_idが必要")]),t._v("\ndf_gbq "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" pd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("read_gbq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("query"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" table_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("split"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"."')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ndisplay"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("df_gbq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("table",[a("thead",[a("tr",[a("th",[t._v("date")]),t._v(" "),a("th",[t._v("id")]),t._v(" "),a("th",[t._v("time")]),t._v(" "),a("th",[t._v("spot")]),t._v(" "),a("th",[t._v("next_time")]),t._v(" "),a("th",[t._v("next_spot")]),t._v(" "),a("th",[t._v("stay_flag")]),t._v(" "),a("th",[t._v("behavior_id")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("0202")]),t._v(" "),a("td",[t._v("26")]),t._v(" "),a("td",[t._v("2018-02-02 15:19:30")]),t._v(" "),a("td",[t._v("spot_1")]),t._v(" "),a("td",[t._v("2018-02-02 15:23:30")]),t._v(" "),a("td",[t._v("spot_1")]),t._v(" "),a("td",[t._v("1")]),t._v(" "),a("td",[t._v("5")])]),t._v(" "),a("tr",[a("td",[t._v("0202")]),t._v(" "),a("td",[t._v("26")]),t._v(" "),a("td",[t._v("2018-02-02 15:23:30")]),t._v(" "),a("td",[t._v("spot_1")]),t._v(" "),a("td",[t._v("2018-02-02 15:24:30")]),t._v(" "),a("td",[t._v("spot_1")]),t._v(" "),a("td",[t._v("1")]),t._v(" "),a("td",[t._v("5")])]),t._v(" "),a("tr",[a("td",[t._v("0221")]),t._v(" "),a("td",[t._v("376")]),t._v(" "),a("td",[t._v("2018-02-21 13:36:30")]),t._v(" "),a("td",[t._v("spot_1")]),t._v(" "),a("td",[t._v("2018-02-21 13:41:30")]),t._v(" "),a("td",[t._v("spot_1")]),t._v(" "),a("td",[t._v("1")]),t._v(" "),a("td",[t._v("9999")])]),t._v(" "),a("tr",[a("td",[t._v("0221")]),t._v(" "),a("td",[t._v("376")]),t._v(" "),a("td",[t._v("2018-02-21 13:41:30")]),t._v(" "),a("td",[t._v("spot_1")]),t._v(" "),a("td",[t._v("2018-02-21 13:43:30")]),t._v(" "),a("td",[t._v("spot_1")]),t._v(" "),a("td",[t._v("1")]),t._v(" "),a("td",[t._v("9999")])])])]),t._v(" "),a("h4",{attrs:{id:"データ型の確認と変更-3"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#データ型の確認と変更-3"}},[t._v("#")]),t._v(" データ型の確認と変更")]),t._v(" "),a("p",[t._v("Int64ではエラーが出るので、int64に変更します")]),t._v(" "),a("div",{staticClass:"language-python extra-class"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# display(df_gbq.dtypes)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Int64 -> int64")]),t._v("\ndf_gbq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"id"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" df_gbq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"id"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("astype"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'int'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ndf_gbq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"stay_flag"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" df_gbq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"stay_flag"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("astype"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'int'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ndf_gbq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"behavior_id"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" df_gbq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"behavior_id"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("astype"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'int'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ndisplay"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("df_gbq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dtypes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# date                   object")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# id                      int64")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# time           datetime64[ns]")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# spot                   object")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# next_time      datetime64[ns]")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# next_spot              object")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# stay_flag               int64")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# behavior_id             int64")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# dtype: object")]),t._v("\n")])])]),a("h4",{attrs:{id:"bqに格納-3"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#bqに格納-3"}},[t._v("#")]),t._v(" BQに格納")]),t._v(" "),a("p",[t._v("下記のコードで新たにテーブルを作成します。")]),t._v(" "),a("div",{staticClass:"language-python extra-class"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# pandasからBQに格納(アップデート)")]),t._v("\nbq_update_pandas"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("df_gbq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"prep_table"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("div",{staticClass:"language-python extra-class"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# テーブル名")]),t._v("\ntable_name "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"prep_table"')]),t._v("\ndataset "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" bq_client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("get_dataset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dataset_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ntable_id "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'%s.%s.%s'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("%")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dataset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("project"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" dataset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dataset_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" table_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# クエリ")]),t._v("\nquery "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string-interpolation"}},[a("span",{pre:!0,attrs:{class:"token string"}},[t._v("f'''SELECT * \n            FROM ")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("table_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("\n            LIMIT 10'''")])]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# strベースのクエリと、project_idが必要")]),t._v("\ndf_gbq "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" pd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("read_gbq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("query"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" table_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("split"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"."')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ndisplay"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("df_gbq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("table",[a("thead",[a("tr",[a("th",[t._v("date")]),t._v(" "),a("th",[t._v("id")]),t._v(" "),a("th",[t._v("time")]),t._v(" "),a("th",[t._v("spot")]),t._v(" "),a("th",[t._v("next_time")]),t._v(" "),a("th",[t._v("next_spot")]),t._v(" "),a("th",[t._v("stay_flag")]),t._v(" "),a("th",[t._v("behavior_id")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("0202")]),t._v(" "),a("td",[t._v("26")]),t._v(" "),a("td",[t._v("2018-02-02 15:19:30")]),t._v(" "),a("td",[t._v("spot_1")]),t._v(" "),a("td",[t._v("2018-02-02 15:23:30")]),t._v(" "),a("td",[t._v("spot_1")]),t._v(" "),a("td",[t._v("1")]),t._v(" "),a("td",[t._v("5")])]),t._v(" "),a("tr",[a("td",[t._v("0202")]),t._v(" "),a("td",[t._v("26")]),t._v(" "),a("td",[t._v("2018-02-02 15:23:30")]),t._v(" "),a("td",[t._v("spot_1")]),t._v(" "),a("td",[t._v("2018-02-02 15:24:30")]),t._v(" "),a("td",[t._v("spot_1")]),t._v(" "),a("td",[t._v("1")]),t._v(" "),a("td",[t._v("5")])]),t._v(" "),a("tr",[a("td",[t._v("0202")]),t._v(" "),a("td",[t._v("26")]),t._v(" "),a("td",[t._v("2018-02-02 15:33:30")]),t._v(" "),a("td",[t._v("spot_1")]),t._v(" "),a("td",[t._v("2018-02-02 15:34:30")]),t._v(" "),a("td",[t._v("spot_1")]),t._v(" "),a("td",[t._v("1")]),t._v(" "),a("td",[t._v("5")])]),t._v(" "),a("tr",[a("td",[t._v("0202")]),t._v(" "),a("td",[t._v("26")]),t._v(" "),a("td",[t._v("2018-02-02 15:34:30")]),t._v(" "),a("td",[t._v("spot_1")]),t._v(" "),a("td",[t._v("2018-02-02 15:36:30")]),t._v(" "),a("td",[t._v("spot_2")]),t._v(" "),a("td",[t._v("0")]),t._v(" "),a("td",[t._v("10")])]),t._v(" "),a("tr",[a("td",[t._v("0202")]),t._v(" "),a("td",[t._v("26")]),t._v(" "),a("td",[t._v("2018-02-02 15:36:30")]),t._v(" "),a("td",[t._v("spot_2")]),t._v(" "),a("td",[t._v("2018-02-02 15:41:30")]),t._v(" "),a("td",[t._v("spot_2")]),t._v(" "),a("td",[t._v("1")]),t._v(" "),a("td",[t._v("15")])])])]),t._v(" "),a("h3",{attrs:{id:"行動id-behavior-id-ごとに集計"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#行動id-behavior-id-ごとに集計"}},[t._v("#")]),t._v(" 行動ID(behavior_id)ごとに集計")]),t._v(" "),a("p",[t._v("spotにいつから,いつまで滞在・移動していたかを、行動ID(behavior_id)ごとに集計します。")]),t._v(" "),a("div",{staticClass:"language-python extra-class"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# テーブル名")]),t._v("\ntable_name "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"prep_table"')]),t._v("\ndataset "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" bq_client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("get_dataset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dataset_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ntable_id "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'%s.%s.%s'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("%")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dataset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("project"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" dataset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dataset_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" table_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# クエリ")]),t._v("\nquery "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string-interpolation"}},[a("span",{pre:!0,attrs:{class:"token string"}},[t._v("f'''\n    SELECT \n        date,　id,\n        spot, MIN(time) AS in_time,\n        next_spot, MAX(next_time) AS out_time,\n        stay_flag, behavior_id\n    FROM \n        ")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("table_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("\n    GROUP BY date,　id, behavior_id, spot, next_spot, stay_flag\n    ORDER BY in_time,　id\n    '''")])]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# strベースのクエリと、project_idが必要")]),t._v("\ndf_gbq "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" pd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("read_gbq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("query"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" table_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("split"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"."')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# display(df_gbq)")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# データの確認")]),t._v("\ndf_gbq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("df_gbq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"date"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0202"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("df_gbq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"id"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("26")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),a("table",[a("thead",[a("tr",[a("th",[t._v("date")]),t._v(" "),a("th",[t._v("id")]),t._v(" "),a("th",[t._v("spot")]),t._v(" "),a("th",[t._v("in_time")]),t._v(" "),a("th",[t._v("next_spot")]),t._v(" "),a("th",[t._v("out_time")]),t._v(" "),a("th",[t._v("stay_flag")]),t._v(" "),a("th",[t._v("behavior_id")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("0202")]),t._v(" "),a("td",[t._v("26")]),t._v(" "),a("td",[t._v("spot_1")]),t._v(" "),a("td",[t._v("2018-02-02 15:19:30")]),t._v(" "),a("td",[t._v("spot_1")]),t._v(" "),a("td",[t._v("2018-02-02 15:34:30")]),t._v(" "),a("td",[t._v("1")]),t._v(" "),a("td",[t._v("5")])]),t._v(" "),a("tr",[a("td",[t._v("0202")]),t._v(" "),a("td",[t._v("26")]),t._v(" "),a("td",[t._v("spot_1")]),t._v(" "),a("td",[t._v("2018-02-02 15:34:30")]),t._v(" "),a("td",[t._v("spot_2")]),t._v(" "),a("td",[t._v("2018-02-02 15:36:30")]),t._v(" "),a("td",[t._v("0")]),t._v(" "),a("td",[t._v("10")])]),t._v(" "),a("tr",[a("td",[t._v("0202")]),t._v(" "),a("td",[t._v("26")]),t._v(" "),a("td",[t._v("spot_2")]),t._v(" "),a("td",[t._v("2018-02-02 15:36:30")]),t._v(" "),a("td",[t._v("spot_2")]),t._v(" "),a("td",[t._v("2018-02-02 16:08:30")]),t._v(" "),a("td",[t._v("1")]),t._v(" "),a("td",[t._v("15")])]),t._v(" "),a("tr",[a("td",[t._v("0202")]),t._v(" "),a("td",[t._v("26")]),t._v(" "),a("td",[t._v("spot_2")]),t._v(" "),a("td",[t._v("2018-02-02 16:08:30")]),t._v(" "),a("td",[t._v("spot_4")]),t._v(" "),a("td",[t._v("2018-02-02 16:12:30")]),t._v(" "),a("td",[t._v("0")]),t._v(" "),a("td",[t._v("20")])]),t._v(" "),a("tr",[a("td",[t._v("0202")]),t._v(" "),a("td",[t._v("26")]),t._v(" "),a("td",[t._v("spot_4")]),t._v(" "),a("td",[t._v("2018-02-02 16:12:30")]),t._v(" "),a("td",[t._v("spot_4")]),t._v(" "),a("td",[t._v("2018-02-02 16:47:30")]),t._v(" "),a("td",[t._v("1")]),t._v(" "),a("td",[t._v("9999")])])])]),t._v(" "),a("h4",{attrs:{id:"データ型の確認と変更-4"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#データ型の確認と変更-4"}},[t._v("#")]),t._v(" データ型の確認と変更")]),t._v(" "),a("p",[t._v("Int64ではエラーが出るので、int64に変更します")]),t._v(" "),a("div",{staticClass:"language-python extra-class"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# display(df_gbq.dtypes)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Int64 -> int64")]),t._v("\ndf_gbq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"id"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" df_gbq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"id"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("astype"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'int'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ndf_gbq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"stay_flag"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" df_gbq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"stay_flag"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("astype"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'int'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ndf_gbq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"behavior_id"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" df_gbq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"behavior_id"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("astype"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'int'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ndisplay"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("df_gbq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dtypes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# date                   object")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# id                      int64")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# spot                   object")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# in_time        datetime64[ns]")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# next_spot              object")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# out_time       datetime64[ns]")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# stay_flag               int64")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# behavior_id             int64")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# dtype: object")]),t._v("\n")])])]),a("h4",{attrs:{id:"bqに格納-4"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#bqに格納-4"}},[t._v("#")]),t._v(" BQに格納")]),t._v(" "),a("p",[t._v("下記のコードで新たにテーブルを作成します。")]),t._v(" "),a("div",{staticClass:"language-python extra-class"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# pandasからBQに格納(アップデート)")]),t._v("\nbq_update_pandas"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("df_gbq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"prep_table"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("div",{staticClass:"language-python extra-class"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# テーブル名")]),t._v("\ntable_name "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"prep_table"')]),t._v("\ndataset "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" bq_client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("get_dataset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dataset_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ntable_id "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'%s.%s.%s'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("%")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dataset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("project"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" dataset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dataset_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" table_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# クエリ")]),t._v("\nquery "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string-interpolation"}},[a("span",{pre:!0,attrs:{class:"token string"}},[t._v("f'''SELECT * \n            FROM ")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("table_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'''")])]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# strベースのクエリと、project_idが必要")]),t._v("\ndf_gbq "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" pd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("read_gbq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("query"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" table_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("split"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"."')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# データの確認")]),t._v("\ndf_gbq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("df_gbq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"date"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0202"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("df_gbq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"id"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("26")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),a("h2",{attrs:{id:"参考サイト"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考サイト"}},[t._v("#")]),t._v(" 参考サイト")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://blog.imind.jp/entry/2019/12/08/025818",target:"_blank",rel:"noopener noreferrer"}},[t._v("PythonでBigQueryの操作"),a("OutboundLink")],1)]),t._v(" "),a("p",[a("a",{attrs:{href:"https://qiita.com/komiya_____/items/8fd900006bbb2ebeb8b8",target:"_blank",rel:"noopener noreferrer"}},[t._v("BigQuery ↔ Pandas間で読み込み/書き込み"),a("OutboundLink")],1)]),t._v(" "),a("p",[a("a",{attrs:{href:"https://qiita.com/Hyperion13fleet/items/0e00f4070f623dacf92b",target:"_blank",rel:"noopener noreferrer"}},[t._v("[BigQuery] BigQueryのPython用APIの使い方 -テーブル作成編-"),a("OutboundLink")],1)]),t._v(" "),a("p",[a("a",{attrs:{href:"https://qiita.com/toyotomihideyoshi/items/b44f66adaa5f02bfe449",target:"_blank",rel:"noopener noreferrer"}},[t._v("Google BigQueryでLEFTJOINしたい"),a("OutboundLink")],1)]),t._v(" "),a("p",[a("a",{attrs:{href:"https://style.potepan.com/articles/23566.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("連番を振るROW_NUMBER関数を解説"),a("OutboundLink")],1)]),t._v(" "),a("p",[a("a",{attrs:{href:"https://docs.microsoft.com/ja-jp/azure/azure-sql-edge/imputing-missing-values",target:"_blank",rel:"noopener noreferrer"}},[t._v("時間のギャップを埋めて欠損値を補完する"),a("OutboundLink")],1)]),t._v(" "),a("p",[a("a",{attrs:{href:"https://zenn.dev/justice_vsbr/articles/780235b4a4bd5d",target:"_blank",rel:"noopener noreferrer"}},[t._v("BigQueryである条件を満たす直近の行を抽出するSQL"),a("OutboundLink")],1)]),t._v(" "),a("p",[a("a",{attrs:{href:"https://gotto50105010.hatenablog.com/entry/2018/12/21/233915",target:"_blank",rel:"noopener noreferrer"}},[t._v("【図解】SQLでJOINを使う方法（OUTER・LEFT・RIGHT）"),a("OutboundLink")],1)]),t._v(" "),a("p",[a("a",{attrs:{href:"https://qiita.com/tlokweng/items/fc13dc30cc1aa28231c5",target:"_blank",rel:"noopener noreferrer"}},[t._v("分析関数（ウインドウ関数）をわかりやすく説明してみた"),a("OutboundLink")],1)]),t._v(" "),a("p",[a("a",{attrs:{href:"https://cloud.google.com/bigquery/docs/reference/standard-sql/navigation_functions",target:"_blank",rel:"noopener noreferrer"}},[t._v("ナビゲーション関数 FIRST_VALUE"),a("OutboundLink")],1)]),t._v(" "),a("p",[a("a",{attrs:{href:"https://qiita.com/hoto17296/items/b6c90db4b9bcdb7b6d78",target:"_blank",rel:"noopener noreferrer"}},[t._v("Pandas で欠損値を含む整数型を扱う"),a("OutboundLink")],1)]),t._v(" "),a("ClientOnly",[a("CallInArticleAdsense")],1),t._v(" "),a("p",[a("a",{attrs:{href:"//af.moshimo.com/af/c/click?a_id=2604050&p_id=1555&pc_id=2816&pl_id=29835&guid=ON",rel:"nofollow",referrerpolicy:"no-referrer-when-downgrade"}},[a("img",{staticStyle:{border:"none"},attrs:{src:"//image.moshimo.com/af-img/0866/000000029835.jpg",width:"728",height:"90"}})]),a("img",{staticStyle:{border:"none"},attrs:{src:"//i.moshimo.com/af/i/impression?a_id=2604050&p_id=1555&pc_id=2816&pl_id=29835",width:"1",height:"1"}})]),t._v(" "),a("p",[a("a",{attrs:{href:"//af.moshimo.com/af/c/click?a_id=2641145&p_id=1770&pc_id=3386&pl_id=25847&guid=ON",rel:"nofollow",referrerpolicy:"no-referrer-when-downgrade"}},[a("img",{staticStyle:{border:"none"},attrs:{src:"//image.moshimo.com/af-img/1115/000000025847.png",width:"728",height:"90"}})]),a("img",{staticStyle:{border:"none"},attrs:{src:"//i.moshimo.com/af/i/impression?a_id=2641145&p_id=1770&pc_id=3386&pl_id=25847",width:"1",height:"1"}})])],1)}),[],!1,null,null,null);s.default=e.exports}}]);
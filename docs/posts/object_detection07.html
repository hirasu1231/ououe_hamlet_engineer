<!DOCTYPE html>
<html lang="ja-jp">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Python + Google Colab + yolov4-deepsortでバイクをカウントする | ハムレット型エンジニアのカンニングノート</title>
    <meta name="generator" content="VuePress 1.8.2">
    <script data-ad-client="ca-pub-2263820744635038" async="true" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <meta name="description" content="バイク検出のモデルを作成いたしましたので，DeepSortというトラッキング(物体追跡)を使いIDを振り分けることでバイクカウントを実施します．">
    <meta property="article:published_time" content="2021-03-04T00:00:00.000Z">
    <meta property="article:modified_time" content="2021-08-21T03:21:52.000Z">
    <meta property="og:site_name" content="ハムレット型エンジニアのカンニングノート">
    <meta property="og:title" content="Python + Google Colab + yolov4-deepsortでバイクをカウントする">
    <meta property="og:description" content="バイク検出のモデルを作成いたしましたので，DeepSortというトラッキング(物体追跡)を使いIDを振り分けることでバイクカウントを実施します．">
    <meta property="og:type" content="article">
    <meta property="og:url" content="/posts/object_detection07.html">
    <meta property="og:image" content="https://www.hamlet-engineer.com/image/count_bike.png">
    <meta name="twitter:title" content="Python + Google Colab + yolov4-deepsortでバイクをカウントする">
    <meta name="twitter:description" content="バイク検出のモデルを作成いたしましたので，DeepSortというトラッキング(物体追跡)を使いIDを振り分けることでバイクカウントを実施します．">
    <meta name="twitter:url" content="/posts/object_detection07.html">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://www.hamlet-engineer.com/image/count_bike.png">
    <meta name="twitter:label2" content="Filed under">
    <meta name="twitter:data2" content="Python, Jupyter, 物体検出, YOLO, トラッキング, Google Colab">
    <meta property="article:tag" content="Python">
    <meta name="google-site-verification" content="BDXGk8FJfikB_I6Pyxv35Zc87jBMziCgRMvmpNDpdYA">
    
    <link rel="preload" href="/assets/css/0.styles.f79f4c23.css" as="style"><link rel="preload" href="/assets/js/app.4c81c8c3.js" as="script"><link rel="preload" href="/assets/js/95.321abe81.js" as="script"><link rel="prefetch" href="/assets/js/10.015492fa.js"><link rel="prefetch" href="/assets/js/100.52ecf106.js"><link rel="prefetch" href="/assets/js/101.97a440f7.js"><link rel="prefetch" href="/assets/js/102.8efffe48.js"><link rel="prefetch" href="/assets/js/103.2170c2e8.js"><link rel="prefetch" href="/assets/js/104.6cfa005d.js"><link rel="prefetch" href="/assets/js/105.c7aa1eac.js"><link rel="prefetch" href="/assets/js/106.b1a610cf.js"><link rel="prefetch" href="/assets/js/107.4c720bb7.js"><link rel="prefetch" href="/assets/js/108.4143261a.js"><link rel="prefetch" href="/assets/js/109.ef82640b.js"><link rel="prefetch" href="/assets/js/11.44151ea1.js"><link rel="prefetch" href="/assets/js/110.2394614c.js"><link rel="prefetch" href="/assets/js/111.2b00dc46.js"><link rel="prefetch" href="/assets/js/112.2af1135b.js"><link rel="prefetch" href="/assets/js/113.c919a6ad.js"><link rel="prefetch" href="/assets/js/114.cccb7aa0.js"><link rel="prefetch" href="/assets/js/115.5ca29375.js"><link rel="prefetch" href="/assets/js/116.2dc135ee.js"><link rel="prefetch" href="/assets/js/117.09d7a4aa.js"><link rel="prefetch" href="/assets/js/118.2f337225.js"><link rel="prefetch" href="/assets/js/119.679fdbea.js"><link rel="prefetch" href="/assets/js/12.28381c1e.js"><link rel="prefetch" href="/assets/js/120.5ac87f88.js"><link rel="prefetch" href="/assets/js/121.06a23e58.js"><link rel="prefetch" href="/assets/js/122.98e95567.js"><link rel="prefetch" href="/assets/js/123.6df3f182.js"><link rel="prefetch" href="/assets/js/124.812a4842.js"><link rel="prefetch" href="/assets/js/125.47b3a97d.js"><link rel="prefetch" href="/assets/js/126.ce16b1d0.js"><link rel="prefetch" href="/assets/js/13.b8326b61.js"><link rel="prefetch" href="/assets/js/14.9894a209.js"><link rel="prefetch" href="/assets/js/15.777eb7bb.js"><link rel="prefetch" href="/assets/js/16.1cb5921d.js"><link rel="prefetch" href="/assets/js/17.3a564565.js"><link rel="prefetch" href="/assets/js/18.29b51f0a.js"><link rel="prefetch" href="/assets/js/19.75ab9adf.js"><link rel="prefetch" href="/assets/js/2.83d55d0b.js"><link rel="prefetch" href="/assets/js/20.9553725a.js"><link rel="prefetch" href="/assets/js/21.93393cf4.js"><link rel="prefetch" href="/assets/js/22.f15abcbb.js"><link rel="prefetch" href="/assets/js/23.7b011ad9.js"><link rel="prefetch" href="/assets/js/24.fb3767f9.js"><link rel="prefetch" href="/assets/js/25.4df606b7.js"><link rel="prefetch" href="/assets/js/26.431a09a7.js"><link rel="prefetch" href="/assets/js/27.bb5b93a7.js"><link rel="prefetch" href="/assets/js/28.8a0b2d55.js"><link rel="prefetch" href="/assets/js/29.d70fa673.js"><link rel="prefetch" href="/assets/js/3.8a4c4a20.js"><link rel="prefetch" href="/assets/js/30.4ee7d4c9.js"><link rel="prefetch" href="/assets/js/31.6993573b.js"><link rel="prefetch" href="/assets/js/32.6f51fe40.js"><link rel="prefetch" href="/assets/js/33.dd7a6567.js"><link rel="prefetch" href="/assets/js/34.4af21419.js"><link rel="prefetch" href="/assets/js/35.cb136c50.js"><link rel="prefetch" href="/assets/js/36.7438f49f.js"><link rel="prefetch" href="/assets/js/37.ccd24ce9.js"><link rel="prefetch" href="/assets/js/38.31e46adf.js"><link rel="prefetch" href="/assets/js/39.78bebaef.js"><link rel="prefetch" href="/assets/js/4.827b393a.js"><link rel="prefetch" href="/assets/js/40.ba724aee.js"><link rel="prefetch" href="/assets/js/41.ac9fa01b.js"><link rel="prefetch" href="/assets/js/42.488fed67.js"><link rel="prefetch" href="/assets/js/43.35a081e0.js"><link rel="prefetch" href="/assets/js/44.f3d9d7f3.js"><link rel="prefetch" href="/assets/js/45.41457d7e.js"><link rel="prefetch" href="/assets/js/46.b9d4ee1f.js"><link rel="prefetch" href="/assets/js/47.350ae38e.js"><link rel="prefetch" href="/assets/js/48.a589bfe7.js"><link rel="prefetch" href="/assets/js/49.5e003b71.js"><link rel="prefetch" href="/assets/js/5.74cf20b7.js"><link rel="prefetch" href="/assets/js/50.2d5dbe00.js"><link rel="prefetch" href="/assets/js/51.a3d3d881.js"><link rel="prefetch" href="/assets/js/52.01df2ce1.js"><link rel="prefetch" href="/assets/js/53.b46a4fc9.js"><link rel="prefetch" href="/assets/js/54.03837104.js"><link rel="prefetch" href="/assets/js/55.636c0ba6.js"><link rel="prefetch" href="/assets/js/56.ad127f25.js"><link rel="prefetch" href="/assets/js/57.2a5a5ea2.js"><link rel="prefetch" href="/assets/js/58.a4fe1fc4.js"><link rel="prefetch" href="/assets/js/59.fda85b6c.js"><link rel="prefetch" href="/assets/js/6.913c84b4.js"><link rel="prefetch" href="/assets/js/60.8b96813f.js"><link rel="prefetch" href="/assets/js/61.f9c839f4.js"><link rel="prefetch" href="/assets/js/62.c1eb007a.js"><link rel="prefetch" href="/assets/js/63.95f37c59.js"><link rel="prefetch" href="/assets/js/64.cdd4440e.js"><link rel="prefetch" href="/assets/js/65.37f632e3.js"><link rel="prefetch" href="/assets/js/66.f8c75cf2.js"><link rel="prefetch" href="/assets/js/67.f5ca177d.js"><link rel="prefetch" href="/assets/js/68.45ed5ded.js"><link rel="prefetch" href="/assets/js/69.25387148.js"><link rel="prefetch" href="/assets/js/7.e918a77f.js"><link rel="prefetch" href="/assets/js/70.043efc1f.js"><link rel="prefetch" href="/assets/js/71.fecd53fa.js"><link rel="prefetch" href="/assets/js/72.4f4949ab.js"><link rel="prefetch" href="/assets/js/73.82477ae9.js"><link rel="prefetch" href="/assets/js/74.18bb4661.js"><link rel="prefetch" href="/assets/js/75.2a0c37a1.js"><link rel="prefetch" href="/assets/js/76.2aa2f685.js"><link rel="prefetch" href="/assets/js/77.bfc948c0.js"><link rel="prefetch" href="/assets/js/78.92b5bc37.js"><link rel="prefetch" href="/assets/js/79.58b1fa6b.js"><link rel="prefetch" href="/assets/js/8.a24b99f1.js"><link rel="prefetch" href="/assets/js/80.cc008218.js"><link rel="prefetch" href="/assets/js/81.279cecf3.js"><link rel="prefetch" href="/assets/js/82.b0a843cc.js"><link rel="prefetch" href="/assets/js/83.a43ef223.js"><link rel="prefetch" href="/assets/js/84.48af61bb.js"><link rel="prefetch" href="/assets/js/85.3ee08f99.js"><link rel="prefetch" href="/assets/js/86.3a6ae7b9.js"><link rel="prefetch" href="/assets/js/87.44e3d166.js"><link rel="prefetch" href="/assets/js/88.3ab1a8bc.js"><link rel="prefetch" href="/assets/js/89.3cfb9e9d.js"><link rel="prefetch" href="/assets/js/9.e008d612.js"><link rel="prefetch" href="/assets/js/90.ccdc508d.js"><link rel="prefetch" href="/assets/js/91.60352319.js"><link rel="prefetch" href="/assets/js/92.db04aebb.js"><link rel="prefetch" href="/assets/js/93.8953c7c3.js"><link rel="prefetch" href="/assets/js/94.c4673186.js"><link rel="prefetch" href="/assets/js/96.e4480355.js"><link rel="prefetch" href="/assets/js/97.46697833.js"><link rel="prefetch" href="/assets/js/98.e477e13e.js"><link rel="prefetch" href="/assets/js/99.11680e82.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f79f4c23.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><section id="global-layout" data-v-98a81704><header class="header" data-v-00466d8e data-v-98a81704><div class="header-navbar" data-v-00466d8e><div class="flex-xbc main header-nav" data-v-00466d8e><div class="nav-link" data-v-00466d8e><a href="/" class="inblock link-logo router-link-active" data-v-00466d8e><img data-src="/logo.png" loading="lazy" alt="logo" class="logo-img lazy" data-v-00466d8e></a> <nav class="link-list" data-v-00466d8e><a href="/" class="list-item router-link-active" data-v-00466d8e>ホーム</a><a href="/about/" class="list-item" data-v-00466d8e>ページ集</a><a href="/posts/" class="list-item router-link-active" data-v-00466d8e>技術</a><a href="/mental/" class="list-item" data-v-00466d8e>メンタル</a><a href="/other/" class="list-item" data-v-00466d8e>その他</a><a href="/tag/" class="list-item" data-v-00466d8e>タグ</a><a href="/category/" class="list-item" data-v-00466d8e>カテゴリ</a><a href="https://twitter.com/hirasu1231" target="_blank" rel="noopener noreferrer" class="list-item" data-v-00466d8e>筆者</a></nav></div> <div class="search-box" data-v-00466d8e><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div></div> </header> <!----> <section class="page" data-v-98a81704 data-v-98a81704><section class="info no-bg" data-v-2602fa21><article class="main info-content" data-v-c4dc5dfa data-v-2602fa21><div class="content-header" data-v-c4dc5dfa><h1 class="header-title" data-v-c4dc5dfa>Python + Google Colab + yolov4-deepsortでバイクをカウントする</h1></div> <div class="flex-wcc content-tag" data-v-c4dc5dfa><div class="inblock tag-list" data-v-c4dc5dfa><a href="/category/Python/" class="tag-text" data-v-c4dc5dfa>Python
      </a></div> <span class="tag-space" data-v-c4dc5dfa>/</span> <div class="inblock tag-list" data-v-c4dc5dfa><a href="/tag/Python/" class="tag-text" data-v-c4dc5dfa>Python
      </a><a href="/tag/Jupyter/" class="tag-text" data-v-c4dc5dfa>Jupyter
      </a><a href="/tag/物体検出/" class="tag-text" data-v-c4dc5dfa>物体検出
      </a><a href="/tag/YOLO/" class="tag-text" data-v-c4dc5dfa>YOLO
      </a><a href="/tag/トラッキング/" class="tag-text" data-v-c4dc5dfa>トラッキング
      </a><a href="/tag/Google Colab/" class="tag-text" data-v-c4dc5dfa>Google Colab
      </a></div></div> <div class="content content__default" data-v-c4dc5dfa><p>バイク検出のモデルを作成いたしましたので，DeepSortというトラッキング(物体追跡)を使い，Youtubeの<a href="https://www.youtube.com/watch?v=wnRH3-CIk4I" target="_blank" rel="noopener noreferrer">平成24年 元旦配達出発式<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>のバイクをカウントします．<br></p> <!----> <p>今回はGoogle ColabとGoogle Driveを連携させて，notebook形式で実行してます．<br></p> <blockquote><p>Google Colaboratory（以下Google Colab）は、Google社が無料で提供している機械学習の教育や研究用の開発環境です。開発環境はJupyter Notebookに似たインターフェースを持ち、Pythonの主要なライブラリがプリインストールされています。<br>
引用元：<a href="https://interface.cqpub.co.jp/ail01/" target="_blank" rel="noopener noreferrer">Google Colabの使い方<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p></p><div class="table-of-contents"><ul><li><a href="#google-colabのファイル構成">Google Colabのファイル構成</a></li><li><a href="#deepsort">DeepSort</a></li><li><a href="#yolov4-deepsort">yolov4-deepsort</a><ul><li><a href="#yolov4-deepsortのダウンロード">yolov4-deepsortのダウンロード</a></li></ul></li><li><a href="#yolov4-deepsortの起動チェック">yolov4-deepsortの起動チェック</a><ul><li><a href="#初期重みのダウンロード">初期重みのダウンロード</a></li><li><a href="#モジュールのインストール">モジュールのインストール</a></li></ul></li><li><a href="#重みの変換">重みの変換</a><ul><li><a href="#テストの実行">テストの実行</a></li></ul></li><li><a href="#yolov4-deepsortで検出">yolov4-deepsortで検出</a><ul><li><a href="#学習モデルの変換">学習モデルの変換</a></li><li><a href="#yolov4-deepsortで検出">yolov4-deepsortで検出</a></li></ul></li><li><a href="#yolov4-deepsortでバイクをカウント">yolov4-deepsortでバイクをカウント</a><ul><li><a href="#課題1-バイクが半分見切れたりした際に-idが変化する">課題1：バイクが半分見切れたりした際に，IDが変化する</a></li><li><a href="#課題2-バイクの全体像が写っていてもidが急に変化する">課題2：バイクの全体像が写っていてもIDが急に変化する</a></li><li><a href="#課題3-バイクのが重なり合って-奥側のバイクが検出できない">課題3：バイクのが重なり合って，奥側のバイクが検出できない．</a></li><li><a href="#カウントの条件">カウントの条件</a></li><li><a href="#yolov4-deepsortでバイクをカウント">yolov4-deepsortでバイクをカウント</a></li><li><a href="#yolov4-deepsortでバイクをカウント結果">yolov4-deepsortでバイクをカウント結果</a></li></ul></li><li><a href="#まとめ">まとめ</a></li><li><a href="#参考サイト">参考サイト</a></li></ul></div><p></p> <p><a href="https://px.a8.net/svt/ejp?a8mat=3HBXCY+4DRW36+50+2HM5Z5" rel="nofollow"><img border="0" width="1000" height="124" alt="" src="https://www27.a8.net/svt/bgt?aid=210508450265&amp;wid=001&amp;eno=01&amp;mid=s00000000018015052000&amp;mc=1"></a><img border="0" width="1" height="1" src="https://www10.a8.net/0.gif?a8mat=3HBXCY+4DRW36+50+2HM5Z5" alt=""></p> <p><a href="https://px.a8.net/svt/ejp?a8mat=3HIN6N+3YAMCY+CO4+6BMG1" rel="nofollow"><img border="0" width="1000" height="124" alt="" src="https://www23.a8.net/svt/bgt?aid=210821855239&amp;wid=001&amp;eno=01&amp;mid=s00000001642001062000&amp;mc=1"></a><img border="0" width="1" height="1" src="https://www17.a8.net/0.gif?a8mat=3HIN6N+3YAMCY+CO4+6BMG1" alt=""></p> <p><a href="https://px.a8.net/svt/ejp?a8mat=3HIN6N+7FBNEA+4AQ0+5YJRM" rel="nofollow">全国630店舗以上！もみほぐし・足つぼ・ハンドリフレ・クイックヘッドのリラクゼーション店【りらくる】</a><img border="0" width="1" height="1" src="https://www15.a8.net/0.gif?a8mat=3HIN6N+7FBNEA+4AQ0+5YJRM" alt=""></p> <h2 id="google-colabのファイル構成"><a href="#google-colabのファイル構成" class="header-anchor">#</a> Google Colabのファイル構成</h2> <p>プロジェクトディレクトリはpost_bikeとしています．度々，省略しています．</p> <div class="language- extra-class"><pre class="language-text"><code>post_bike
├── /yolov4-deepsort
│   ├── /checkpoints
│   │   └── /yolov4-416
│   │       └── saved_model.pb
│   ├── /outputs
│   │   └── demo.mp4
│   ├── /data
│   │   └── yolov4.weights
│   ├── /core
│   │   └── config.py
│   ├── /deep_sort
│   │   └── tracker.py
│   ├── /post_bike_weight &lt;- 独自モデル
│   │   ├── yolov4_bike.names
│   │   └── /darknet
│   │       ├── /yolov4_bike_best.pb
│   │       └── yolov4_bike_best.weights
│   ├── object_tracker.py
│   ├── object_tracker_bike.py &lt;- バイクカウンター
│   ├── H240101_post.mp4 &lt;- 入力動画
│   ├── darknet_ds_post.mp4 &lt;- 検出動画
│   ├── count_darknet_ds_post.mp4 &lt;- カウント動画
│   └── (省略)
└── yolov4-deepsort.ipynb &lt;- 実行用ノートブック
</code></pre></div><h2 id="deepsort"><a href="#deepsort" class="header-anchor">#</a> DeepSort</h2> <blockquote><p>DeepSortは人物のトラッキングを行う機械学習モデルです。人物にIDをつけてトラッキングすることができます。<br>
従来、トラッキングでは、カルマンフィルタを使用したSortというアルゴリズムが使用されていました。YOLO v3で検出したバウンディングボックスを使用して、フレームの前後で近い大きさと近い動きのバウンディングボックスを対応づけることで、人物にIDをつけてトラッキングします。<br>
しかし、Sortでは、人物が物体の影に隠れて、再び現れた場合に違うIDがつけられてしまうという問題がありました。DeepSortでは、人物の類似性を比較するAIモデルを使用することで、この問題を解決し、人物のIDのスイッチングを減少させることができます。<br>
引用元:<a href="https://medium.com/axinc/deepsort-%E4%BA%BA%E7%89%A9%E3%81%AE%E3%83%88%E3%83%A9%E3%83%83%E3%82%AD%E3%83%B3%E3%82%B0%E3%82%92%E8%A1%8C%E3%81%86%E6%A9%9F%E6%A2%B0%E5%AD%A6%E7%BF%92%E3%83%A2%E3%83%87%E3%83%AB-e8cb7410457c" target="_blank" rel="noopener noreferrer">DeepSort : 人物のトラッキングを行う機械学習モデル<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <h2 id="yolov4-deepsort"><a href="#yolov4-deepsort" class="header-anchor">#</a> yolov4-deepsort</h2> <h3 id="yolov4-deepsortのダウンロード"><a href="#yolov4-deepsortのダウンロード" class="header-anchor">#</a> yolov4-deepsortのダウンロード</h3> <p>Google ColabとGoogle Driveを連携させて，gitからyolov4-deepsortをダウンロードします．</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># Google ColabとGoogle Driveを連携</span>
<span class="token keyword">from</span> google<span class="token punctuation">.</span>colab <span class="token keyword">import</span> drive
drive<span class="token punctuation">.</span>mount<span class="token punctuation">(</span><span class="token string">'/content/drive'</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">%</span><span class="token operator">%</span>bash
<span class="token comment"># ディレクトリの移動</span>
cd drive<span class="token operator">/</span>MyDrive<span class="token operator">/</span>post_bike<span class="token operator">/</span>
<span class="token comment"># gitのダウンロード</span>
git clone https<span class="token punctuation">:</span><span class="token operator">//</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>theAIGuysCode<span class="token operator">/</span>yolov4<span class="token operator">-</span>deepsort<span class="token punctuation">.</span>git
</code></pre></div><h2 id="yolov4-deepsortの起動チェック"><a href="#yolov4-deepsortの起動チェック" class="header-anchor">#</a> yolov4-deepsortの起動チェック</h2> <p>正常に起動するか，デフォルトで入っている動画を検出させてチェックします．</p> <h3 id="初期重みのダウンロード"><a href="#初期重みのダウンロード" class="header-anchor">#</a> 初期重みのダウンロード</h3> <p>今回は起動するかチェックするために，YOLOv4学習済みのパラメータをダウンロードします．</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># ディレクトリの移動</span>
<span class="token operator">%</span>cd <span class="token operator">/</span>content<span class="token operator">/</span>drive<span class="token operator">/</span>MyDrive<span class="token operator">/</span>post_bike<span class="token operator">/</span>yolov4<span class="token operator">-</span>deepsort<span class="token operator">/</span>data<span class="token operator">/</span>
<span class="token comment"># 初期重みをダウンロード</span>
!wget https<span class="token punctuation">:</span><span class="token operator">//</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>AlexeyAB<span class="token operator">/</span>darknet<span class="token operator">/</span>releases<span class="token operator">/</span>download<span class="token operator">/</span>darknet_yolo_v3_optimal<span class="token operator">/</span>yolov4<span class="token punctuation">.</span>weights
</code></pre></div><h3 id="モジュールのインストール"><a href="#モジュールのインストール" class="header-anchor">#</a> モジュールのインストール</h3> <p>yolov4-deepsortに応じて，モジュールをインストールします．</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># ディレクトリの移動</span>
<span class="token operator">%</span>cd <span class="token operator">/</span>content<span class="token operator">/</span>drive<span class="token operator">/</span>MyDrive<span class="token operator">/</span>post_bike<span class="token operator">/</span>yolov4<span class="token operator">-</span>deepsort<span class="token operator">/</span>
<span class="token comment"># TensorFlow GPU</span>
!pip install <span class="token operator">-</span>r requirements<span class="token operator">-</span>gpu<span class="token punctuation">.</span>txt
</code></pre></div><h2 id="重みの変換"><a href="#重みの変換" class="header-anchor">#</a> 重みの変換</h2> <p>darknet用の重みをtensorflowで使えるように変換します．(./data/yolov4.weight -&gt; ./checkpoints/yolov4-416/saved_model.pb)</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># ディレクトリの移動</span>
<span class="token operator">%</span>cd <span class="token operator">/</span>content<span class="token operator">/</span>drive<span class="token operator">/</span>MyDrive<span class="token operator">/</span>post_bike<span class="token operator">/</span>yolov4<span class="token operator">-</span>deepsort<span class="token operator">/</span>
<span class="token comment"># darknet weights to tensorflow model</span>
!python save_model<span class="token punctuation">.</span>py <span class="token operator">-</span><span class="token operator">-</span>model yolov4 
</code></pre></div><h3 id="テストの実行"><a href="#テストの実行" class="header-anchor">#</a> テストの実行</h3> <p>GPUが認識しているかの確認後，検出が実行しkeras-yolo4が正常に起動するか確認します．</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf

<span class="token comment"># GPUの起動確認</span>
device_name <span class="token operator">=</span> tf<span class="token punctuation">.</span>test<span class="token punctuation">.</span>gpu_device_name<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> device_name <span class="token operator">!=</span> <span class="token string">'/device:GPU:0'</span><span class="token punctuation">:</span>
  <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'GPU device not found'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Found GPU at: {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>device_name<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># Found GPU at: /device:GPU:0</span>
</code></pre></div><p>object_tracker.pyを実行してdemoの検出を実施します．</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># ディレクトリの移動</span>
<span class="token operator">%</span>cd <span class="token operator">/</span>content<span class="token operator">/</span>drive<span class="token operator">/</span>MyDrive<span class="token operator">/</span>post_bike<span class="token operator">/</span>yolov4<span class="token operator">-</span>deepsort<span class="token operator">/</span>
<span class="token comment"># 検出を実行</span>
!python object_tracker<span class="token punctuation">.</span>py <span class="token operator">-</span><span class="token operator">-</span>video <span class="token punctuation">.</span><span class="token operator">/</span>data<span class="token operator">/</span>video<span class="token operator">/</span>test<span class="token punctuation">.</span>mp4 <span class="token operator">-</span><span class="token operator">-</span>output <span class="token punctuation">.</span><span class="token operator">/</span>outputs<span class="token operator">/</span>demo<span class="token punctuation">.</span>mp4 <span class="token operator">-</span><span class="token operator">-</span>model yolov4 <span class="token operator">-</span><span class="token operator">-</span>dont_show
</code></pre></div><p><code>./outputs/demo.mp4</code><br> <img alt="" data-src="/image/demo.gif" loading="lazy" class="lazy"></p> <h2 id="yolov4-deepsortで検出"><a href="#yolov4-deepsortで検出" class="header-anchor">#</a> yolov4-deepsortで検出</h2> <p>yolov4-deepsortも起動も確認できたので，yolov4-deepsortでトラッキング付きでバイク検出を実施し，バイクのカウントに向けての問題点等を整理します．<br>
今回はわりと安定して検出できたDarknetの重みを使用します．<br></p> <h3 id="学習モデルの変換"><a href="#学習モデルの変換" class="header-anchor">#</a> 学習モデルの変換</h3> <p>Darknetで学習したモデルをtfモデルに変換します．本稿では，独自で学習したモデルをいれるために，新たなディレクトリを作成します．</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># ディレクトリの移動</span>
<span class="token operator">%</span>cd <span class="token operator">/</span>content<span class="token operator">/</span>drive<span class="token operator">/</span>MyDrive<span class="token operator">/</span>post_bike<span class="token operator">/</span>yolov4<span class="token operator">-</span>deepsort<span class="token operator">/</span>
<span class="token comment"># 独自モデル用のディレクトリ作成</span>
!mkdir <span class="token operator">-</span>p <span class="token punctuation">.</span><span class="token operator">/</span>post_bike_weight<span class="token operator">/</span>darknet
!mkdir <span class="token operator">-</span>p <span class="token punctuation">.</span><span class="token operator">/</span>post_bike_weight<span class="token operator">/</span>keras
!ls post_bike_weight
</code></pre></div><p>darknetからtfモデルに変換します．<br>
クラスがデフォルトでcocoの80クラスに設定されているので，<code>core/config.py</code>を更新します．<br> <code>yolov4_bike.names</code>は<a href="https://hirasu1231.github.io/hamlet_engineer/posts/2021/02/24/object-detection03.html" target="_blank" rel="noopener noreferrer">Darknet(Yolov4)で学習させるためのcfgファイル等を作成する<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>で作成したファイルです．</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># core/config.py</span>
<span class="token comment"># 14行目を更新</span>
__C<span class="token punctuation">.</span>YOLO<span class="token punctuation">.</span>CLASSES <span class="token operator">=</span> <span class="token string">&quot;./post_bike_weight/yolov4_bike.names&quot;</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># ディレクトリの移動</span>
<span class="token operator">%</span>cd <span class="token operator">/</span>content<span class="token operator">/</span>drive<span class="token operator">/</span>MyDrive<span class="token operator">/</span>post_bike<span class="token operator">/</span>yolov4<span class="token operator">-</span>deepsort<span class="token operator">/</span>
<span class="token comment"># darknet weights to tensorflow model</span>
!python save_model<span class="token punctuation">.</span>py \
              <span class="token operator">-</span><span class="token operator">-</span>weights <span class="token punctuation">.</span><span class="token operator">/</span>post_bike_weight<span class="token operator">/</span>darknet<span class="token operator">/</span>yolov4_bike_best<span class="token punctuation">.</span>weights \
              <span class="token operator">-</span><span class="token operator">-</span>output <span class="token punctuation">.</span><span class="token operator">/</span>post_bike_weight<span class="token operator">/</span>darknet<span class="token operator">/</span>yolov4_bike_best<span class="token punctuation">.</span>pb \
              <span class="token operator">-</span><span class="token operator">-</span>input_size <span class="token number">608</span> \
              <span class="token operator">-</span><span class="token operator">-</span>model yolov4 \
<span class="token comment"># 確認</span>
!ls post_bike_weight<span class="token operator">/</span>darknet<span class="token operator">/</span>

<span class="token comment">#  出力</span>
<span class="token comment"># yolov4_bike_best.pb  yolov4_bike_best.weights</span>
</code></pre></div><h3 id="yolov4-deepsortで検出-2"><a href="#yolov4-deepsortで検出-2" class="header-anchor">#</a> yolov4-deepsortで検出</h3> <p>以下のコードでyolov4-deepsortでトラッキング付きでバイク検出を実施します．</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># ディレクトリの移動</span>
<span class="token operator">%</span>cd <span class="token operator">/</span>content<span class="token operator">/</span>drive<span class="token operator">/</span>MyDrive<span class="token operator">/</span>post_bike<span class="token operator">/</span>yolov4<span class="token operator">-</span>deepsort<span class="token operator">/</span>
<span class="token comment"># 検出を実行</span>
!python object_tracker<span class="token punctuation">.</span>py \
            <span class="token operator">-</span><span class="token operator">-</span>weights  <span class="token punctuation">.</span><span class="token operator">/</span>post_bike_weight<span class="token operator">/</span>darknet<span class="token operator">/</span>yolov4_bike_best<span class="token punctuation">.</span>pb \
            <span class="token operator">-</span><span class="token operator">-</span>size <span class="token number">608</span> \
            <span class="token operator">-</span><span class="token operator">-</span>video H240101_post<span class="token punctuation">.</span>mp4 \
            <span class="token operator">-</span><span class="token operator">-</span>output darknet_ds_post<span class="token punctuation">.</span>mp4 \
            <span class="token operator">-</span><span class="token operator">-</span>model yolov4 \
            <span class="token operator">-</span><span class="token operator">-</span>iou <span class="token number">0.45</span> \
            <span class="token operator">-</span><span class="token operator">-</span>score <span class="token number">0.50</span> \
            <span class="token operator">-</span><span class="token operator">-</span>dont_show
!ls
<span class="token comment"># darknet_ds_post.mp4</span>
</code></pre></div><p><code>darknet_ds_post.mp4</code><br> <img alt="" data-src="/image/maxage60_df_gif.gif" loading="lazy" class="lazy"></p> <h2 id="yolov4-deepsortでバイクをカウント"><a href="#yolov4-deepsortでバイクをカウント" class="header-anchor">#</a> yolov4-deepsortでバイクをカウント</h2> <p>yolov4-deepsortでトラッキング付きでバイク検出を実施しましたので，バイクのカウントに向けての問題点等を整理します．<br>
動画の両端に左赤，右緑の検出線を描画し，Bounding Boxが検出線を通過したらバイクをカウントするようにします．</p> <h3 id="課題1-バイクが半分見切れたりした際に-idが変化する"><a href="#課題1-バイクが半分見切れたりした際に-idが変化する" class="header-anchor">#</a> 課題1：バイクが半分見切れたりした際に，IDが変化する</h3> <p>IDの振る際に検出物の特徴も考慮しているため，半分見切れることで検出物の特徴が変化したためIDが振り直されたと思われます．<br>
検出線と交差したBounding Boxの内，Bounding Boxの座標が動画のフレーム外，または極端に左端・右端に近い場合はカウントしないものとします．
<img alt="" data-src="/image/kadai1.png" loading="lazy" class="lazy"><br></p> <h3 id="課題2-バイクの全体像が写っていてもidが急に変化する"><a href="#課題2-バイクの全体像が写っていてもidが急に変化する" class="header-anchor">#</a> 課題2：バイクの全体像が写っていてもIDが急に変化する</h3> <p>DeepSortがデフォルトの60フレーム先までの軌跡を等速直線運動で予測するので，停止線付近のバイクでも予測軌跡上にあれば，郵便局倉庫の入口付近で検出されたID:156に上書きされて検出されます．<br> <img alt="" data-src="/image/kadai2.png" loading="lazy" class="lazy"><br>
今回は，両端での検出を実施するために，予測軌跡を描くフレーム数をデフォルトで60フレーム先から15フレーム先に変更する．<br> <code>./deep_sort/tracker.py</code>の40行目 max_age=15<br></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># ./deep_sort/tracker.p</span>
<span class="token comment"># 40行目</span>
<span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> metric<span class="token punctuation">,</span> max_iou_distance<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">,</span> max_age<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">,</span> n_init<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</code></pre></div><h3 id="課題3-バイクのが重なり合って-奥側のバイクが検出できない"><a href="#課題3-バイクのが重なり合って-奥側のバイクが検出できない" class="header-anchor">#</a> 課題3：バイクのが重なり合って，奥側のバイクが検出できない．</h3> <p>画角が低くバイクのが重なり合って，奥側のバイクが検出されません．<br> <img alt="" data-src="/image/kadai3.png" loading="lazy" class="lazy"><br>
以下の3案から考慮し最善と思われる案1を採用します，</p> <ul><li>(○)案1:検出線をバイクが重なりにくいところに設置する
<ul><li>停止線の付近ではバイクの重なりが多く検出もれが多くなります．検出動画からすると，左は出口専用の看板付近，右は黄色ポールの付近に鉛直方向に描画するのが良いと思われます．
<img alt="" data-src="/image/an_1.png" loading="lazy" class="lazy"><br> <br></li></ul></li> <li>(△)案2:検出を線ではなく領域とする．
<ul><li>検出物であるバイクの重なりが多い本動画では領域で検出すると，重なりが取れた後にIDが変化し，過剰にカウントされる可能性があるため，あまり良い案とは思えません．</li> <li>重なりが取れた後のID変化を防ぐために，max_ageの数値を大きくすることも考えられますが，本動画ではバイクの移動距離が短く予測軌跡が特定の場所で留まることが多いため，どちらにしろ，過剰にカウントされる可能性があります．
<img alt="" data-src="/image/an_2.png" loading="lazy" class="lazy"><br> <br></li></ul></li> <li>(△)案3:検出線を動画の端と駐車場の出口で複数用意する．
<ul><li>案2と同様に，重なりが取れた後にIDが変化し過剰にカウントされる可能性があるため，あまり良い案とは思えない．
<img alt="" data-src="/image/an_3.png" loading="lazy" class="lazy"><br></li></ul></li></ul> <h3 id="カウントの条件"><a href="#カウントの条件" class="header-anchor">#</a> カウントの条件</h3> <p>カウントする条件をif文を記述し，リストにIDを追加するようにする．条件は以下ようにしました．</p> <ul><li>Bounding Boxが検出線を交差する．</li> <li>リストに追加済みのIDは追加しない．</li> <li>Bounding Boxが動画のフレーム外にある場合はリストに追加しない．</li></ul> <p>以下はカウントの条件を考慮して，バイクをカウントするコードを簡単に示したものです．</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># 線分p1-p2と線分p3-p4の交差</span>
<span class="token comment"># p1 =  (0, 0)</span>
<span class="token keyword">def</span> <span class="token function">intersect</span><span class="token punctuation">(</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">,</span> p3<span class="token punctuation">,</span> p4<span class="token punctuation">)</span><span class="token punctuation">:</span>
    tc1 <span class="token operator">=</span> <span class="token punctuation">(</span>p1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> p2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>p3<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> p1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>p1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> p2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>p1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> p3<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    tc2 <span class="token operator">=</span> <span class="token punctuation">(</span>p1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> p2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>p4<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> p1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>p1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> p2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>p1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> p4<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    td1 <span class="token operator">=</span> <span class="token punctuation">(</span>p3<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> p4<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>p1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> p3<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>p3<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> p4<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>p3<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> p1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    td2 <span class="token operator">=</span> <span class="token punctuation">(</span>p3<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> p4<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>p2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> p3<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>p3<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> p4<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>p3<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> p2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> tc1<span class="token operator">*</span>tc2<span class="token operator">&lt;</span><span class="token number">0</span> <span class="token keyword">and</span> td1<span class="token operator">*</span>td2<span class="token operator">&lt;</span><span class="token number">0</span>

<span class="token comment"># カウントリスト</span>
<span class="token comment"># 右の検出線</span>
rd1<span class="token punctuation">,</span> rd2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1700</span><span class="token punctuation">,</span> <span class="token number">250</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1700</span><span class="token punctuation">,</span> height<span class="token punctuation">)</span>
right_conter <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token comment"># 左の検出線</span>
ld1<span class="token punctuation">,</span> ld2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">250</span><span class="token punctuation">,</span> <span class="token number">250</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">250</span><span class="token punctuation">,</span> height<span class="token punctuation">)</span>
left_conter <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token comment"># while video is running(動画のフレームごとで検出)</span>
<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''
    (省略)
    DeepSortでBounding Boxの座標を取得するコード
    bbox = [左上のx座標, 左上のy座標, 右下のx座標, 右下のy座標]
    '''</span>

    <span class="token comment"># Bounding Boxの座標</span>
    tr<span class="token punctuation">,</span> lb <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>bbox<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>bbox<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>bbox<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>bbox<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 右側カウンター</span>
    <span class="token comment"># Bounding Boxと検出線の交差するかどうか</span>
    r_bb_cross <span class="token operator">=</span> intersect<span class="token punctuation">(</span>tr<span class="token punctuation">,</span> lb<span class="token punctuation">,</span> rd1<span class="token punctuation">,</span> rd2<span class="token punctuation">)</span>
    <span class="token comment"># 新規のIDかどうか</span>
    r_added <span class="token operator">=</span> track<span class="token punctuation">.</span>track_id <span class="token keyword">not</span> <span class="token keyword">in</span> right_conter
    <span class="token comment"># Bounding Boxが動画のフレーム外にあるか</span>
    r_not_video <span class="token operator">=</span> tr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token number">0</span> <span class="token keyword">or</span> lb<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&lt;</span>width
    <span class="token comment"># 条件を照査</span>
    <span class="token keyword">if</span> r_bb_cross <span class="token keyword">and</span> r_added <span class="token keyword">and</span> r_not_video<span class="token punctuation">:</span>
        right_conter<span class="token punctuation">.</span>append<span class="token punctuation">(</span>track<span class="token punctuation">.</span>track_id<span class="token punctuation">)</span>
    
    <span class="token comment"># 左側カウンター</span>
    <span class="token comment"># Bounding Boxと検出線の交差するかどうか</span>
    l_bb_cross <span class="token operator">=</span> intersect<span class="token punctuation">(</span>tr<span class="token punctuation">,</span> lb<span class="token punctuation">,</span> ld1<span class="token punctuation">,</span> ld2<span class="token punctuation">)</span>
    <span class="token comment"># 新規のIDかどうか</span>
    l_added <span class="token operator">=</span> track<span class="token punctuation">.</span>track_id <span class="token keyword">not</span> <span class="token keyword">in</span> left_conter
    <span class="token comment"># Bounding Boxが動画のフレーム外にあるか</span>
    l_not_video <span class="token operator">=</span> tr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token number">0</span> <span class="token keyword">or</span> lb<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&lt;</span>width
    <span class="token comment"># 条件を照査</span>
    <span class="token keyword">if</span> l_bb_cross <span class="token keyword">and</span> l_added <span class="token keyword">and</span> l_not_video<span class="token punctuation">:</span>
        left_conter<span class="token punctuation">.</span>append<span class="token punctuation">(</span>track<span class="token punctuation">.</span>track_id<span class="token punctuation">)</span>
    
    <span class="token comment"># バイクカウントの様子を描画</span>
    <span class="token comment"># 左の検出線</span>
    cv2<span class="token punctuation">.</span>line<span class="token punctuation">(</span>frame<span class="token punctuation">,</span> ld1<span class="token punctuation">,</span> ld2<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> thickness<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
    cv2<span class="token punctuation">.</span>putText<span class="token punctuation">(</span>frame<span class="token punctuation">,</span> <span class="token string">&quot;LEFT : {}&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>left_conter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">150</span><span class="token punctuation">,</span> <span class="token number">230</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 右の検出線</span>
    cv2<span class="token punctuation">.</span>line<span class="token punctuation">(</span>frame<span class="token punctuation">,</span> rd1<span class="token punctuation">,</span> rd2<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> thickness<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
    cv2<span class="token punctuation">.</span>putText<span class="token punctuation">(</span>frame<span class="token punctuation">,</span> <span class="token string">&quot;RIGHT : {}&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>right_conter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">1600</span><span class="token punctuation">,</span> <span class="token number">230</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="yolov4-deepsortでバイクをカウント-2"><a href="#yolov4-deepsortでバイクをカウント-2" class="header-anchor">#</a> yolov4-deepsortでバイクをカウント</h3> <p>独自で設定したカウントの条件を<code>object_tracker.py</code>に組み込んだ<code>object_tracker_bike.py</code>を作成します．</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># object_tracker_bike.py</span>
<span class="token keyword">import</span> os
<span class="token comment"># comment out below line to enable tensorflow logging outputs</span>
os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">'TF_CPP_MIN_LOG_LEVEL'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'3'</span>
<span class="token keyword">import</span> time
<span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf
physical_devices <span class="token operator">=</span> tf<span class="token punctuation">.</span>config<span class="token punctuation">.</span>experimental<span class="token punctuation">.</span>list_physical_devices<span class="token punctuation">(</span><span class="token string">'GPU'</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>physical_devices<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
    tf<span class="token punctuation">.</span>config<span class="token punctuation">.</span>experimental<span class="token punctuation">.</span>set_memory_growth<span class="token punctuation">(</span>physical_devices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token keyword">from</span> absl <span class="token keyword">import</span> app<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> logging
<span class="token keyword">from</span> absl<span class="token punctuation">.</span>flags <span class="token keyword">import</span> FLAGS
<span class="token keyword">import</span> core<span class="token punctuation">.</span>utils <span class="token keyword">as</span> utils
<span class="token keyword">from</span> core<span class="token punctuation">.</span>yolov4 <span class="token keyword">import</span> filter_boxes
<span class="token keyword">from</span> tensorflow<span class="token punctuation">.</span>python<span class="token punctuation">.</span>saved_model <span class="token keyword">import</span> tag_constants
<span class="token keyword">from</span> core<span class="token punctuation">.</span>config <span class="token keyword">import</span> cfg
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
<span class="token keyword">import</span> cv2
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">from</span> tensorflow<span class="token punctuation">.</span>compat<span class="token punctuation">.</span>v1 <span class="token keyword">import</span> ConfigProto
<span class="token keyword">from</span> tensorflow<span class="token punctuation">.</span>compat<span class="token punctuation">.</span>v1 <span class="token keyword">import</span> InteractiveSession
<span class="token comment"># deep sort imports</span>
<span class="token keyword">from</span> deep_sort <span class="token keyword">import</span> preprocessing<span class="token punctuation">,</span> nn_matching
<span class="token keyword">from</span> deep_sort<span class="token punctuation">.</span>detection <span class="token keyword">import</span> Detection
<span class="token keyword">from</span> deep_sort<span class="token punctuation">.</span>tracker <span class="token keyword">import</span> Tracker
<span class="token keyword">from</span> tools <span class="token keyword">import</span> generate_detections <span class="token keyword">as</span> gdet
flags<span class="token punctuation">.</span>DEFINE_string<span class="token punctuation">(</span><span class="token string">'framework'</span><span class="token punctuation">,</span> <span class="token string">'tf'</span><span class="token punctuation">,</span> <span class="token string">'(tf, tflite, trt'</span><span class="token punctuation">)</span>
flags<span class="token punctuation">.</span>DEFINE_string<span class="token punctuation">(</span><span class="token string">'weights'</span><span class="token punctuation">,</span> <span class="token string">'./checkpoints/yolov4-416'</span><span class="token punctuation">,</span>
                    <span class="token string">'path to weights file'</span><span class="token punctuation">)</span>
flags<span class="token punctuation">.</span>DEFINE_integer<span class="token punctuation">(</span><span class="token string">'size'</span><span class="token punctuation">,</span> <span class="token number">416</span><span class="token punctuation">,</span> <span class="token string">'resize images to'</span><span class="token punctuation">)</span>
flags<span class="token punctuation">.</span>DEFINE_boolean<span class="token punctuation">(</span><span class="token string">'tiny'</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">'yolo or yolo-tiny'</span><span class="token punctuation">)</span>
flags<span class="token punctuation">.</span>DEFINE_string<span class="token punctuation">(</span><span class="token string">'model'</span><span class="token punctuation">,</span> <span class="token string">'yolov4'</span><span class="token punctuation">,</span> <span class="token string">'yolov3 or yolov4'</span><span class="token punctuation">)</span>
flags<span class="token punctuation">.</span>DEFINE_string<span class="token punctuation">(</span><span class="token string">'video'</span><span class="token punctuation">,</span> <span class="token string">'./data/video/test.mp4'</span><span class="token punctuation">,</span> <span class="token string">'path to input video or set to 0 for webcam'</span><span class="token punctuation">)</span>
flags<span class="token punctuation">.</span>DEFINE_string<span class="token punctuation">(</span><span class="token string">'output'</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">'path to output video'</span><span class="token punctuation">)</span>
flags<span class="token punctuation">.</span>DEFINE_string<span class="token punctuation">(</span><span class="token string">'output_format'</span><span class="token punctuation">,</span> <span class="token string">'XVID'</span><span class="token punctuation">,</span> <span class="token string">'codec used in VideoWriter when saving video to file'</span><span class="token punctuation">)</span>
flags<span class="token punctuation">.</span>DEFINE_float<span class="token punctuation">(</span><span class="token string">'iou'</span><span class="token punctuation">,</span> <span class="token number">0.45</span><span class="token punctuation">,</span> <span class="token string">'iou threshold'</span><span class="token punctuation">)</span>
flags<span class="token punctuation">.</span>DEFINE_float<span class="token punctuation">(</span><span class="token string">'score'</span><span class="token punctuation">,</span> <span class="token number">0.50</span><span class="token punctuation">,</span> <span class="token string">'score threshold'</span><span class="token punctuation">)</span>
flags<span class="token punctuation">.</span>DEFINE_boolean<span class="token punctuation">(</span><span class="token string">'dont_show'</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">'dont show video output'</span><span class="token punctuation">)</span>
flags<span class="token punctuation">.</span>DEFINE_boolean<span class="token punctuation">(</span><span class="token string">'info'</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">'show detailed info of tracked objects'</span><span class="token punctuation">)</span>
flags<span class="token punctuation">.</span>DEFINE_boolean<span class="token punctuation">(</span><span class="token string">'count'</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">'count objects being tracked on screen'</span><span class="token punctuation">)</span>


<span class="token comment"># 線分p1-p2と線分p3-p4の交差</span>
<span class="token comment"># p1 =  (0, 0)</span>
<span class="token keyword">def</span> <span class="token function">intersect</span><span class="token punctuation">(</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">,</span> p3<span class="token punctuation">,</span> p4<span class="token punctuation">)</span><span class="token punctuation">:</span>
    tc1 <span class="token operator">=</span> <span class="token punctuation">(</span>p1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> p2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>p3<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> p1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>p1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> p2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>p1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> p3<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    tc2 <span class="token operator">=</span> <span class="token punctuation">(</span>p1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> p2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>p4<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> p1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>p1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> p2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>p1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> p4<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    td1 <span class="token operator">=</span> <span class="token punctuation">(</span>p3<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> p4<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>p1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> p3<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>p3<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> p4<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>p3<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> p1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    td2 <span class="token operator">=</span> <span class="token punctuation">(</span>p3<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> p4<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>p2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> p3<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>p3<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> p4<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>p3<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> p2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> tc1<span class="token operator">*</span>tc2<span class="token operator">&lt;</span><span class="token number">0</span> <span class="token keyword">and</span> td1<span class="token operator">*</span>td2<span class="token operator">&lt;</span><span class="token number">0</span>

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>_argv<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Definition of the parameters(検出の閾値)</span>
    max_cosine_distance <span class="token operator">=</span> <span class="token number">0.4</span>
    nn_budget <span class="token operator">=</span> <span class="token boolean">None</span>
    nms_max_overlap <span class="token operator">=</span> <span class="token number">1.0</span>
    
    <span class="token comment"># initialize deep sort(deep sortの初期化)</span>
    model_filename <span class="token operator">=</span> <span class="token string">'model_data/mars-small128.pb'</span>
    encoder <span class="token operator">=</span> gdet<span class="token punctuation">.</span>create_box_encoder<span class="token punctuation">(</span>model_filename<span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment"># calculate cosine distance metric</span>
    metric <span class="token operator">=</span> nn_matching<span class="token punctuation">.</span>NearestNeighborDistanceMetric<span class="token punctuation">(</span><span class="token string">&quot;cosine&quot;</span><span class="token punctuation">,</span> max_cosine_distance<span class="token punctuation">,</span> nn_budget<span class="token punctuation">)</span>
    <span class="token comment"># initialize tracker</span>
    tracker <span class="token operator">=</span> Tracker<span class="token punctuation">(</span>metric<span class="token punctuation">)</span>

    <span class="token comment"># load configuration for object detector(検出の設定)</span>
    config <span class="token operator">=</span> ConfigProto<span class="token punctuation">(</span><span class="token punctuation">)</span>
    config<span class="token punctuation">.</span>gpu_options<span class="token punctuation">.</span>allow_growth <span class="token operator">=</span> <span class="token boolean">True</span>
    session <span class="token operator">=</span> InteractiveSession<span class="token punctuation">(</span>config<span class="token operator">=</span>config<span class="token punctuation">)</span>
    STRIDES<span class="token punctuation">,</span> ANCHORS<span class="token punctuation">,</span> NUM_CLASS<span class="token punctuation">,</span> XYSCALE <span class="token operator">=</span> utils<span class="token punctuation">.</span>load_config<span class="token punctuation">(</span>FLAGS<span class="token punctuation">)</span>
    input_size <span class="token operator">=</span> FLAGS<span class="token punctuation">.</span>size
    video_path <span class="token operator">=</span> FLAGS<span class="token punctuation">.</span>video

    <span class="token comment"># load tflite model if flag is set(モデルの読み込み)</span>
    <span class="token keyword">if</span> FLAGS<span class="token punctuation">.</span>framework <span class="token operator">==</span> <span class="token string">'tflite'</span><span class="token punctuation">:</span>
        interpreter <span class="token operator">=</span> tf<span class="token punctuation">.</span>lite<span class="token punctuation">.</span>Interpreter<span class="token punctuation">(</span>model_path<span class="token operator">=</span>FLAGS<span class="token punctuation">.</span>weights<span class="token punctuation">)</span>
        interpreter<span class="token punctuation">.</span>allocate_tensors<span class="token punctuation">(</span><span class="token punctuation">)</span>
        input_details <span class="token operator">=</span> interpreter<span class="token punctuation">.</span>get_input_details<span class="token punctuation">(</span><span class="token punctuation">)</span>
        output_details <span class="token operator">=</span> interpreter<span class="token punctuation">.</span>get_output_details<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>input_details<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>output_details<span class="token punctuation">)</span>
    <span class="token comment"># otherwise load standard tensorflow saved model</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        saved_model_loaded <span class="token operator">=</span> tf<span class="token punctuation">.</span>saved_model<span class="token punctuation">.</span>load<span class="token punctuation">(</span>FLAGS<span class="token punctuation">.</span>weights<span class="token punctuation">,</span> tags<span class="token operator">=</span><span class="token punctuation">[</span>tag_constants<span class="token punctuation">.</span>SERVING<span class="token punctuation">]</span><span class="token punctuation">)</span>
        infer <span class="token operator">=</span> saved_model_loaded<span class="token punctuation">.</span>signatures<span class="token punctuation">[</span><span class="token string">'serving_default'</span><span class="token punctuation">]</span>

    <span class="token comment"># begin video capture(入力動画の読み込み)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        vid <span class="token operator">=</span> cv2<span class="token punctuation">.</span>VideoCapture<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>video_path<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        vid <span class="token operator">=</span> cv2<span class="token punctuation">.</span>VideoCapture<span class="token punctuation">(</span>video_path<span class="token punctuation">)</span>

    out <span class="token operator">=</span> <span class="token boolean">None</span>

    <span class="token comment"># get video ready to save locally if flag is set(出力動画の設定)</span>
    <span class="token keyword">if</span> FLAGS<span class="token punctuation">.</span>output<span class="token punctuation">:</span>
        <span class="token comment"># by default VideoCapture returns float instead of int</span>
        width <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>vid<span class="token punctuation">.</span>get<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>CAP_PROP_FRAME_WIDTH<span class="token punctuation">)</span><span class="token punctuation">)</span>
        height <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>vid<span class="token punctuation">.</span>get<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>CAP_PROP_FRAME_HEIGHT<span class="token punctuation">)</span><span class="token punctuation">)</span>
        fps <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>vid<span class="token punctuation">.</span>get<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>CAP_PROP_FPS<span class="token punctuation">)</span><span class="token punctuation">)</span>
        codec <span class="token operator">=</span> cv2<span class="token punctuation">.</span>VideoWriter_fourcc<span class="token punctuation">(</span><span class="token operator">*</span>FLAGS<span class="token punctuation">.</span>output_format<span class="token punctuation">)</span>
        out <span class="token operator">=</span> cv2<span class="token punctuation">.</span>VideoWriter<span class="token punctuation">(</span>FLAGS<span class="token punctuation">.</span>output<span class="token punctuation">,</span> codec<span class="token punctuation">,</span> fps<span class="token punctuation">,</span> <span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">)</span>
        
    <span class="token comment"># カウントリスト</span>
    <span class="token comment"># 右の検出線</span>
    rd1<span class="token punctuation">,</span> rd2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1700</span><span class="token punctuation">,</span> <span class="token number">250</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1700</span><span class="token punctuation">,</span> height<span class="token punctuation">)</span>
    right_conter <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment"># 左の検出線</span>
    ld1<span class="token punctuation">,</span> ld2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">250</span><span class="token punctuation">,</span> <span class="token number">250</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">250</span><span class="token punctuation">,</span> height<span class="token punctuation">)</span>
    left_conter <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    
    frame_num <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token comment"># while video is running(動画のフレームごとで検出)</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        return_value<span class="token punctuation">,</span> frame <span class="token operator">=</span> vid<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> return_value<span class="token punctuation">:</span>
            frame <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>frame<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2RGB<span class="token punctuation">)</span>
            image <span class="token operator">=</span> Image<span class="token punctuation">.</span>fromarray<span class="token punctuation">(</span>frame<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Video has ended or failed, try a different video format!'</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span>
        
        <span class="token comment"># if frame_num &gt; 600:</span>
        <span class="token comment">#     break</span>
        
        frame_num <span class="token operator">+=</span><span class="token number">1</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Frame #: '</span><span class="token punctuation">,</span> frame_num<span class="token punctuation">)</span>
        frame_size <span class="token operator">=</span> frame<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
        image_data <span class="token operator">=</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>frame<span class="token punctuation">,</span> <span class="token punctuation">(</span>input_size<span class="token punctuation">,</span> input_size<span class="token punctuation">)</span><span class="token punctuation">)</span>
        image_data <span class="token operator">=</span> image_data <span class="token operator">/</span> <span class="token number">255</span><span class="token punctuation">.</span>
        image_data <span class="token operator">=</span> image_data<span class="token punctuation">[</span>np<span class="token punctuation">.</span>newaxis<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
        start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># run detections on tflite if flag is set</span>
        <span class="token keyword">if</span> FLAGS<span class="token punctuation">.</span>framework <span class="token operator">==</span> <span class="token string">'tflite'</span><span class="token punctuation">:</span>
            interpreter<span class="token punctuation">.</span>set_tensor<span class="token punctuation">(</span>input_details<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'index'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> image_data<span class="token punctuation">)</span>
            interpreter<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span><span class="token punctuation">)</span>
            pred <span class="token operator">=</span> <span class="token punctuation">[</span>interpreter<span class="token punctuation">.</span>get_tensor<span class="token punctuation">(</span>output_details<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'index'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>output_details<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            <span class="token comment"># run detections using yolov3 if flag is set</span>
            <span class="token keyword">if</span> FLAGS<span class="token punctuation">.</span>model <span class="token operator">==</span> <span class="token string">'yolov3'</span> <span class="token keyword">and</span> FLAGS<span class="token punctuation">.</span>tiny <span class="token operator">==</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
                boxes<span class="token punctuation">,</span> pred_conf <span class="token operator">=</span> filter_boxes<span class="token punctuation">(</span>pred<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pred<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> score_threshold<span class="token operator">=</span><span class="token number">0.25</span><span class="token punctuation">,</span>
                                                input_shape<span class="token operator">=</span>tf<span class="token punctuation">.</span>constant<span class="token punctuation">(</span><span class="token punctuation">[</span>input_size<span class="token punctuation">,</span> input_size<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                boxes<span class="token punctuation">,</span> pred_conf <span class="token operator">=</span> filter_boxes<span class="token punctuation">(</span>pred<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pred<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> score_threshold<span class="token operator">=</span><span class="token number">0.25</span><span class="token punctuation">,</span>
                                                input_shape<span class="token operator">=</span>tf<span class="token punctuation">.</span>constant<span class="token punctuation">(</span><span class="token punctuation">[</span>input_size<span class="token punctuation">,</span> input_size<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            batch_data <span class="token operator">=</span> tf<span class="token punctuation">.</span>constant<span class="token punctuation">(</span>image_data<span class="token punctuation">)</span>
            pred_bbox <span class="token operator">=</span> infer<span class="token punctuation">(</span>batch_data<span class="token punctuation">)</span>
            <span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> pred_bbox<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                boxes <span class="token operator">=</span> value<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span>
                pred_conf <span class="token operator">=</span> value<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span>

        boxes<span class="token punctuation">,</span> scores<span class="token punctuation">,</span> classes<span class="token punctuation">,</span> valid_detections <span class="token operator">=</span> tf<span class="token punctuation">.</span>image<span class="token punctuation">.</span>combined_non_max_suppression<span class="token punctuation">(</span>
            boxes<span class="token operator">=</span>tf<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> <span class="token punctuation">(</span>tf<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>boxes<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            scores<span class="token operator">=</span>tf<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>
                pred_conf<span class="token punctuation">,</span> <span class="token punctuation">(</span>tf<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>pred_conf<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> tf<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>pred_conf<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            max_output_size_per_class<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span>
            max_total_size<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span>
            iou_threshold<span class="token operator">=</span>FLAGS<span class="token punctuation">.</span>iou<span class="token punctuation">,</span>
            score_threshold<span class="token operator">=</span>FLAGS<span class="token punctuation">.</span>score
        <span class="token punctuation">)</span>

        <span class="token comment"># convert data to numpy arrays and slice out unused elements</span>
        num_objects <span class="token operator">=</span> valid_detections<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        bboxes <span class="token operator">=</span> boxes<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        bboxes <span class="token operator">=</span> bboxes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token builtin">int</span><span class="token punctuation">(</span>num_objects<span class="token punctuation">)</span><span class="token punctuation">]</span>
        scores <span class="token operator">=</span> scores<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        scores <span class="token operator">=</span> scores<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token builtin">int</span><span class="token punctuation">(</span>num_objects<span class="token punctuation">)</span><span class="token punctuation">]</span>
        classes <span class="token operator">=</span> classes<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        classes <span class="token operator">=</span> classes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token builtin">int</span><span class="token punctuation">(</span>num_objects<span class="token punctuation">)</span><span class="token punctuation">]</span>

        <span class="token comment"># format bounding boxes from normalized ymin, xmin, ymax, xmax ---&gt; xmin, ymin, width, height</span>
        original_h<span class="token punctuation">,</span> original_w<span class="token punctuation">,</span> _ <span class="token operator">=</span> frame<span class="token punctuation">.</span>shape
        bboxes <span class="token operator">=</span> utils<span class="token punctuation">.</span>format_boxes<span class="token punctuation">(</span>bboxes<span class="token punctuation">,</span> original_h<span class="token punctuation">,</span> original_w<span class="token punctuation">)</span>

        <span class="token comment"># store all predictions in one parameter for simplicity when calling functions</span>
        pred_bbox <span class="token operator">=</span> <span class="token punctuation">[</span>bboxes<span class="token punctuation">,</span> scores<span class="token punctuation">,</span> classes<span class="token punctuation">,</span> num_objects<span class="token punctuation">]</span>

        <span class="token comment"># read in all class names from config</span>
        class_names <span class="token operator">=</span> utils<span class="token punctuation">.</span>read_class_names<span class="token punctuation">(</span>cfg<span class="token punctuation">.</span>YOLO<span class="token punctuation">.</span>CLASSES<span class="token punctuation">)</span>

        <span class="token comment"># by default allow all classes in .names file</span>
        allowed_classes <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>class_names<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        
        <span class="token comment"># custom allowed classes (uncomment line below to customize tracker for only people)</span>
        <span class="token comment">#allowed_classes = ['person']</span>

        <span class="token comment"># loop through objects and use class index to get class name, allow only classes in allowed_classes list</span>
        names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        deleted_indx <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_objects<span class="token punctuation">)</span><span class="token punctuation">:</span>
            class_indx <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>classes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
            class_name <span class="token operator">=</span> class_names<span class="token punctuation">[</span>class_indx<span class="token punctuation">]</span>
            <span class="token keyword">if</span> class_name <span class="token keyword">not</span> <span class="token keyword">in</span> allowed_classes<span class="token punctuation">:</span>
                deleted_indx<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                names<span class="token punctuation">.</span>append<span class="token punctuation">(</span>class_name<span class="token punctuation">)</span>
        names <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>names<span class="token punctuation">)</span>
        count <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>names<span class="token punctuation">)</span>
        <span class="token keyword">if</span> FLAGS<span class="token punctuation">.</span>count<span class="token punctuation">:</span>
            cv2<span class="token punctuation">.</span>putText<span class="token punctuation">(</span>frame<span class="token punctuation">,</span> <span class="token string">&quot;Objects being tracked: {}&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>FONT_HERSHEY_COMPLEX_SMALL<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Objects being tracked: {}&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># delete detections that are not in allowed_classes</span>
        bboxes <span class="token operator">=</span> np<span class="token punctuation">.</span>delete<span class="token punctuation">(</span>bboxes<span class="token punctuation">,</span> deleted_indx<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        scores <span class="token operator">=</span> np<span class="token punctuation">.</span>delete<span class="token punctuation">(</span>scores<span class="token punctuation">,</span> deleted_indx<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>

        <span class="token comment"># encode yolo detections and feed to tracker</span>
        features <span class="token operator">=</span> encoder<span class="token punctuation">(</span>frame<span class="token punctuation">,</span> bboxes<span class="token punctuation">)</span>
        detections <span class="token operator">=</span> <span class="token punctuation">[</span>Detection<span class="token punctuation">(</span>bbox<span class="token punctuation">,</span> score<span class="token punctuation">,</span> class_name<span class="token punctuation">,</span> feature<span class="token punctuation">)</span> <span class="token keyword">for</span> bbox<span class="token punctuation">,</span> score<span class="token punctuation">,</span> class_name<span class="token punctuation">,</span> feature <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>bboxes<span class="token punctuation">,</span> scores<span class="token punctuation">,</span> names<span class="token punctuation">,</span> features<span class="token punctuation">)</span><span class="token punctuation">]</span>

        <span class="token comment">#initialize color map</span>
        cmap <span class="token operator">=</span> plt<span class="token punctuation">.</span>get_cmap<span class="token punctuation">(</span><span class="token string">'tab20b'</span><span class="token punctuation">)</span>
        colors <span class="token operator">=</span> <span class="token punctuation">[</span>cmap<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> np<span class="token punctuation">.</span>linspace<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

        <span class="token comment"># run non-maxima supression</span>
        boxs <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>d<span class="token punctuation">.</span>tlwh <span class="token keyword">for</span> d <span class="token keyword">in</span> detections<span class="token punctuation">]</span><span class="token punctuation">)</span>
        scores <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>d<span class="token punctuation">.</span>confidence <span class="token keyword">for</span> d <span class="token keyword">in</span> detections<span class="token punctuation">]</span><span class="token punctuation">)</span>
        classes <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>d<span class="token punctuation">.</span>class_name <span class="token keyword">for</span> d <span class="token keyword">in</span> detections<span class="token punctuation">]</span><span class="token punctuation">)</span>
        indices <span class="token operator">=</span> preprocessing<span class="token punctuation">.</span>non_max_suppression<span class="token punctuation">(</span>boxs<span class="token punctuation">,</span> classes<span class="token punctuation">,</span> nms_max_overlap<span class="token punctuation">,</span> scores<span class="token punctuation">)</span>
        detections <span class="token operator">=</span> <span class="token punctuation">[</span>detections<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> indices<span class="token punctuation">]</span>       

        <span class="token comment"># Call the tracker</span>
        tracker<span class="token punctuation">.</span>predict<span class="token punctuation">(</span><span class="token punctuation">)</span>
        tracker<span class="token punctuation">.</span>update<span class="token punctuation">(</span>detections<span class="token punctuation">)</span>

        <span class="token comment"># update tracks</span>
        <span class="token keyword">for</span> track <span class="token keyword">in</span> tracker<span class="token punctuation">.</span>tracks<span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> track<span class="token punctuation">.</span>is_confirmed<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">or</span> track<span class="token punctuation">.</span>time_since_update <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span> 
            bbox <span class="token operator">=</span> track<span class="token punctuation">.</span>to_tlbr<span class="token punctuation">(</span><span class="token punctuation">)</span>
            class_name <span class="token operator">=</span> track<span class="token punctuation">.</span>get_class<span class="token punctuation">(</span><span class="token punctuation">)</span>
            
            <span class="token comment"># draw bbox on screen(Bounding Boxの描画)</span>
            color <span class="token operator">=</span> colors<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>track<span class="token punctuation">.</span>track_id<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token builtin">len</span><span class="token punctuation">(</span>colors<span class="token punctuation">)</span><span class="token punctuation">]</span>
            color <span class="token operator">=</span> <span class="token punctuation">[</span>i <span class="token operator">*</span> <span class="token number">255</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> color<span class="token punctuation">]</span>
            cv2<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span>frame<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>bbox<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>bbox<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>bbox<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>bbox<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> color<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
            cv2<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span>frame<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>bbox<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>bbox<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>bbox<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>class_name<span class="token punctuation">)</span><span class="token operator">+</span><span class="token builtin">len</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>track<span class="token punctuation">.</span>track_id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">17</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>bbox<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> color<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            cv2<span class="token punctuation">.</span>putText<span class="token punctuation">(</span>frame<span class="token punctuation">,</span> class_name <span class="token operator">+</span> <span class="token string">&quot;-&quot;</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>track<span class="token punctuation">.</span>track_id<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>bbox<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>bbox<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.75</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
            
            <span class="token comment"># Bounding Boxの座標</span>
            tr<span class="token punctuation">,</span> lb <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>bbox<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>bbox<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>bbox<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>bbox<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            
            <span class="token comment"># 右側カウンター</span>
            <span class="token comment"># Bounding Boxと検出線の交差するかどうか</span>
            r_bb_cross <span class="token operator">=</span> intersect<span class="token punctuation">(</span>tr<span class="token punctuation">,</span> lb<span class="token punctuation">,</span> rd1<span class="token punctuation">,</span> rd2<span class="token punctuation">)</span>
            <span class="token comment"># 新規のIDかどうか</span>
            r_added <span class="token operator">=</span> track<span class="token punctuation">.</span>track_id <span class="token keyword">not</span> <span class="token keyword">in</span> right_conter
            <span class="token comment"># Bounding Boxが動画のフレーム外にあるか</span>
            r_not_video <span class="token operator">=</span> tr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token number">0</span> <span class="token keyword">or</span> lb<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&lt;</span>width
            <span class="token comment"># 条件を照査</span>
            <span class="token keyword">if</span> r_bb_cross <span class="token keyword">and</span> r_added <span class="token keyword">and</span> r_not_video<span class="token punctuation">:</span>
                right_conter<span class="token punctuation">.</span>append<span class="token punctuation">(</span>track<span class="token punctuation">.</span>track_id<span class="token punctuation">)</span>
            
            <span class="token comment"># 左側カウンター</span>
            <span class="token comment"># Bounding Boxと検出線の交差するかどうか</span>
            l_bb_cross <span class="token operator">=</span> intersect<span class="token punctuation">(</span>tr<span class="token punctuation">,</span> lb<span class="token punctuation">,</span> ld1<span class="token punctuation">,</span> ld2<span class="token punctuation">)</span>
            <span class="token comment"># 新規のIDかどうか</span>
            l_added <span class="token operator">=</span> track<span class="token punctuation">.</span>track_id <span class="token keyword">not</span> <span class="token keyword">in</span> left_conter
            <span class="token comment"># Bounding Boxが動画のフレーム外にあるか</span>
            l_not_video <span class="token operator">=</span> tr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token number">0</span> <span class="token keyword">or</span> lb<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&lt;</span>width
            <span class="token comment"># 条件を照査</span>
            <span class="token keyword">if</span> l_bb_cross <span class="token keyword">and</span> l_added <span class="token keyword">and</span> l_not_video<span class="token punctuation">:</span>
                left_conter<span class="token punctuation">.</span>append<span class="token punctuation">(</span>track<span class="token punctuation">.</span>track_id<span class="token punctuation">)</span>
            

        <span class="token comment"># if enable info flag then print details about each track</span>
            <span class="token keyword">if</span> FLAGS<span class="token punctuation">.</span>info<span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Tracker ID: {}, Class: {},  BBox Coords (xmin, ymin, xmax, ymax): {}&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>track<span class="token punctuation">.</span>track_id<span class="token punctuation">)</span><span class="token punctuation">,</span> class_name<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>bbox<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>bbox<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>bbox<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>bbox<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                
        <span class="token comment"># バイクカウントの様子を描画</span>
        <span class="token comment"># 左の検出線</span>
        cv2<span class="token punctuation">.</span>line<span class="token punctuation">(</span>frame<span class="token punctuation">,</span> ld1<span class="token punctuation">,</span> ld2<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> thickness<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        cv2<span class="token punctuation">.</span>putText<span class="token punctuation">(</span>frame<span class="token punctuation">,</span> <span class="token string">&quot;LEFT : {}&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>left_conter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">150</span><span class="token punctuation">,</span> <span class="token number">230</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 右の検出線</span>
        cv2<span class="token punctuation">.</span>line<span class="token punctuation">(</span>frame<span class="token punctuation">,</span> rd1<span class="token punctuation">,</span> rd2<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> thickness<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        cv2<span class="token punctuation">.</span>putText<span class="token punctuation">(</span>frame<span class="token punctuation">,</span> <span class="token string">&quot;RIGHT : {}&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>right_conter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">1600</span><span class="token punctuation">,</span> <span class="token number">230</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>

        <span class="token comment"># calculate frames per second of running detections</span>
        fps <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start_time<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;FPS: %.2f&quot;</span> <span class="token operator">%</span> fps<span class="token punctuation">)</span>
        result <span class="token operator">=</span> np<span class="token punctuation">.</span>asarray<span class="token punctuation">(</span>frame<span class="token punctuation">)</span>
        result <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>frame<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_RGB2BGR<span class="token punctuation">)</span>
        
        <span class="token keyword">if</span> <span class="token keyword">not</span> FLAGS<span class="token punctuation">.</span>dont_show<span class="token punctuation">:</span>
            cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">&quot;Output Video&quot;</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span>
        
        <span class="token comment"># if output flag is set, save video file</span>
        <span class="token keyword">if</span> FLAGS<span class="token punctuation">.</span>output<span class="token punctuation">:</span>
            out<span class="token punctuation">.</span>write<span class="token punctuation">(</span>result<span class="token punctuation">)</span>
        <span class="token keyword">if</span> cv2<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span> <span class="token operator">==</span> <span class="token builtin">ord</span><span class="token punctuation">(</span><span class="token string">'q'</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">break</span>
    cv2<span class="token punctuation">.</span>destroyAllWindows<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">)</span>
    <span class="token keyword">except</span> SystemExit<span class="token punctuation">:</span>
        <span class="token keyword">pass</span>

</code></pre></div><p>独自で設定したカウントの条件を組み込んだ<code>object_tracker_bike.py</code>を実行します．</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># ディレクトリの移動</span>
<span class="token operator">%</span>cd <span class="token operator">/</span>content<span class="token operator">/</span>drive<span class="token operator">/</span>MyDrive<span class="token operator">/</span>post_bike<span class="token operator">/</span>yolov4<span class="token operator">-</span>deepsort<span class="token operator">/</span>
<span class="token comment"># 検出を実行</span>
!python object_tracker_bike<span class="token punctuation">.</span>py \
            <span class="token operator">-</span><span class="token operator">-</span>weights  <span class="token punctuation">.</span><span class="token operator">/</span>post_bike_weight<span class="token operator">/</span>darknet<span class="token operator">/</span>yolov4_bike_best<span class="token punctuation">.</span>pb \
            <span class="token operator">-</span><span class="token operator">-</span>size <span class="token number">608</span> \
            <span class="token operator">-</span><span class="token operator">-</span>video H240101_post<span class="token punctuation">.</span>mp4 \
            <span class="token operator">-</span><span class="token operator">-</span>output count_darknet_ds_post<span class="token punctuation">.</span>mp4 \
            <span class="token operator">-</span><span class="token operator">-</span>model yolov4 \
            <span class="token operator">-</span><span class="token operator">-</span>iou <span class="token number">0.45</span> \
            <span class="token operator">-</span><span class="token operator">-</span>score <span class="token number">0.50</span> \
            <span class="token operator">-</span><span class="token operator">-</span>dont_show
</code></pre></div><p><code>count_darknet_ds_post.mp4</code><br> <img alt="" data-src="/image/count_gif.gif" loading="lazy" class="lazy"></p> <h3 id="yolov4-deepsortでバイクをカウント結果"><a href="#yolov4-deepsortでバイクをカウント結果" class="header-anchor">#</a> yolov4-deepsortでバイクをカウント結果</h3> <p>yolov4-deepsortでバイクをカウント結果は，実際のものと左右ともに2台の誤差がありました．<br>
バイクが2台重なって検出されなかったり，バイクが見切れた際に前部と後部で別のIDが振られるなどした過検出が見られました．<br> <code>自分でカウントした結果</code></p> <ul><li>左(自分で)　バイク72台</li> <li>左(yolov4)　バイク系70台</li> <li>右(自分で)　バイク系62台</li> <li>右(yolov4)　バイク系60台</li></ul> <h2 id="まとめ"><a href="#まとめ" class="header-anchor">#</a> まとめ</h2> <p>yolov4-deepsortでバイクのカウントを実施しました．<br>
今回のように，画角が低いカメラ位置だとバイクの重複がありますので，少々カウントミスがありました．<br>
また，時間をかけて傾向を見てみたいと思います．<br></p> <h2 id="参考サイト"><a href="#参考サイト" class="header-anchor">#</a> 参考サイト</h2> <p><a href="https://github.com/theAIGuysCode/yolov4-deepsort" target="_blank" rel="noopener noreferrer">theAIGuysCode/yolov4-deepsort<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><br> <a href="https://note.nkmk.me/python-collections-deque/" target="_blank" rel="noopener noreferrer">Pythonのdequeでキュー、スタック、デック（両端キュー）を扱う<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><br> <a href="https://medium.com/axinc/deepsort-%E4%BA%BA%E7%89%A9%E3%81%AE%E3%83%88%E3%83%A9%E3%83%83%E3%82%AD%E3%83%B3%E3%82%B0%E3%82%92%E8%A1%8C%E3%81%86%E6%A9%9F%E6%A2%B0%E5%AD%A6%E7%BF%92%E3%83%A2%E3%83%87%E3%83%AB-e8cb7410457c" target="_blank" rel="noopener noreferrer">DeepSort : 人物のトラッキングを行う機械学習モデル<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><br> <a href="https://ichi.pro/tensorflow-2-de-deepsort-o-shiyoshita-obujyekuto-torakkingu-259490015275855" target="_blank" rel="noopener noreferrer">TensorFlow2でDeepSORTを使用したオブジェクトトラッキング<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://px.a8.net/svt/ejp?a8mat=3HBXCY+4DRW36+50+2HM5Z5" rel="nofollow"><img border="0" width="1000" height="124" alt="" src="https://www27.a8.net/svt/bgt?aid=210508450265&amp;wid=001&amp;eno=01&amp;mid=s00000000018015052000&amp;mc=1"></a><img border="0" width="1" height="1" src="https://www10.a8.net/0.gif?a8mat=3HBXCY+4DRW36+50+2HM5Z5" alt=""></p> <p><a href="https://px.a8.net/svt/ejp?a8mat=3HIN6N+3YAMCY+CO4+6BMG1" rel="nofollow"><img border="0" width="1000" height="124" alt="" src="https://www23.a8.net/svt/bgt?aid=210821855239&amp;wid=001&amp;eno=01&amp;mid=s00000001642001062000&amp;mc=1"></a><img border="0" width="1" height="1" src="https://www17.a8.net/0.gif?a8mat=3HIN6N+3YAMCY+CO4+6BMG1" alt=""></p> <p><a href="https://px.a8.net/svt/ejp?a8mat=3HIN6N+7FBNEA+4AQ0+5YJRM" rel="nofollow">全国630店舗以上！もみほぐし・足つぼ・ハンドリフレ・クイックヘッドのリラクゼーション店【りらくる】</a><img border="0" width="1" height="1" src="https://www15.a8.net/0.gif?a8mat=3HIN6N+7FBNEA+4AQ0+5YJRM" alt=""></p> <!----></div> <div class="content-time" data-v-c4dc5dfa><time datetime="3/4/2021, 12:00:00 AM" class="time-text" data-v-c4dc5dfa>Create Time: 3/4/2021, 12:00:00 AM
    </time> <time datetime="8/21/2021, 3:21:52 AM" class="time-text" data-v-c4dc5dfa>Last Updated: 8/21/2021, 3:21:52 AM
    </time></div></article> <section class="flex-xb main info-nav" data-v-203269c1 data-v-2602fa21><a href="/posts/frame_mp4.html" class="flex-xb nav-item" data-v-203269c1><div class="flex-xcc item-img" data-v-203269c1><img data-src="https://www.hamlet-engineer.com/image/opencv.png" loading="lazy" alt="Python, OpenCVで好きな動画ファイルからフレームを切り出して保存します" class="img lazy" data-v-203269c1></div> <article class="flex-ysc item-content" data-v-203269c1><h2 class="content-title" data-v-203269c1>Python, OpenCVで好きな動画ファイルからフレームを切り出して保存します</h2> <div class="content" data-v-203269c1><p>Python, OpenCVを用いて，任意の秒数単位で動画のフレームを画像として出力するコードを作成します．</p>
</div></article></a> <a href="/posts/object_detection06.html" class="flex-xb nav-item" data-v-203269c1><div class="flex-xcc item-img" data-v-203269c1><img data-src="https://www.hamlet-engineer.com/image/tenni.png" loading="lazy" alt="Python + Google Colab + keras-yolo4でバイク検出を転移学習する" class="img lazy" data-v-203269c1></div> <article class="flex-ysc item-content" data-v-203269c1><h2 class="content-title" data-v-203269c1>Python + Google Colab + keras-yolo4でバイク検出を転移学習する</h2> <div class="content" data-v-203269c1><p>COCOデータセットから特定のクラスの画像を抽出し，アノテーション情報を整形したので，keras-yolo4での転移学習を実施します．</p>
</div></article></a></section> <!----></section></section> <footer class="footer" data-v-8dceedee data-v-98a81704><nav class="link-list" data-v-8dceedee><a href="https://twitter.com/hirasu1231" target="_blank" rel="noopener noreferrer" class="list-item" data-v-8dceedee>Twitter</a><a href="https://github.com/hirasu1231" target="_blank" rel="noopener noreferrer" class="list-item" data-v-8dceedee>Github</a></nav> <a href="/" class="copyright router-link-active" data-v-8dceedee>ハムレット型エンジニアのカンニングノート © 2021</a></footer></section><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.4c81c8c3.js" defer></script><script src="/assets/js/95.321abe81.js" defer></script>
  </body>
</html>
